function Kernel(b,a){this.class_method=b,this.class_name=a}function Class(){this.name=null}var fs;"undefined"!=typeof require&&(fs=require("fs")),Kernel._extend=function(a,b,g){var f;b instanceof Array||(b=[b]);for(var e=0;e<b.length;e++){if(g=void 0===g?!0:g,f=b[e],"string"==typeof f){if(!Class.__class_config[f])return a;f=Class.__class_config[f].methods}g&&(f=CanvasEngine.clone(f));for(var d in f)a[d]=f[d]}return a},Kernel.prototype={New:function(){return this["new"].apply(this,arguments)},"new":function(){return this._class=new Class,Class.__class[this.class_name]=this._class,this._construct(),this._class},_construct:function(){this._class.extend(this.class_method)},_attr_accessor:function(d,a,f){for(var b=this,e=0;e<d.length;e++)this.class_method["_"+d[e]]=null,this.class_method[d[e]]={},a&&(this.class_method[d[e]].set=function(g){b.class_method["_"+d[e]]=g}),f&&(this.class_method[d[e]].get=function(){return b.class_method["_"+d[e]]});return this},attr_accessor:function(a){return this._attr_accessor(a,!0,!0)},attr_reader:function(a){return this._attr_accessor(a,!0,!1)},attr_writer:function(a){return this._attr_accessor(a,!1,!0)},extend:function(a,b){return Kernel._extend(this.class_method,a,b),this},addIn:function(a){return Class.__class[a]?(Class.__class[a][this.name]=this,this):this}},Class.__class={},Class.__class_config={},Class.get=function(a){return Class.__class[a]},Class.create=function(e,d,h){var g,b;if(Class.__class_config[e]={},Class.__class[e]={},h){g=window[e],tmp_class=new Class;for(var f in tmp_class)g[f]=tmp_class[f];for(var f in d)g[f]=d[f];b=g}else{Class.__class_config[e].methods=d;var i=Class.__class_config[e].kernel=new Kernel(Class.__class_config[e].methods,e)}return i},Class.New=function(){return Class["new"].apply(this,arguments)},Class["new"]=function(d,e,a){var b;if("boolean"==typeof e&&(a=e,e=[]),void 0==a&&(a=!0),e=e||[],!Class.__class_config[d])throw d+' class does not exist. Use method "create" for build the structure of this class';return b=Class.__class_config[d].kernel["new"](),a&&b.initialize&&b.initialize.apply(b,e),b.__name__=d,b},Class.prototype={extend:function(a,b){return Kernel._extend(this,a,b)}};var CanvasEngine={};if(CanvasEngine.uniqid=function(){return Math.random()},CanvasEngine.arraySplice=function(b,d){var a;for(a=0;a<d.length;++a)if(b==d[a])return void d.splice(a,1)},CanvasEngine.ajax=function(a){function g(){var e;a.success&&(e=h.responseText,"json"==a.dataType?e=CanvasEngine.parseJSON(e):"xml"==a.dataType&&(e=h.responseXML),a.success(e))}if(a=CanvasEngine.extend({url:"./",type:"GET",statusCode:{}},a),a.data=a.data?JSON.stringify(a.data):null,fs)return void fs.readFile("./"+a.url,"ascii",function(i,e){if(i)throw i;e=e.toString("ascii"),"json"==a.dataType&&(e=CanvasEngine.parseJSON(e)),a.success(e)});var h;try{h=new ActiveXObject("Msxml2.XMLHTTP")}catch(f){try{h=new ActiveXObject("Microsoft.XMLHTTP")}catch(d){try{h=new XMLHttpRequest}catch(b){h=!1}}}h.onreadystatechange=function(){4==h.readyState&&(a.statusCode&&a.statusCode[h.status]&&a.statusCode[h.status](),200==h.status?g():a.error&&a.error(h))},h.open(a.type,a.url,!0),a.mimeType&&h.overrideMimeType(a.mimeType),h.send(a.data)},CanvasEngine.getJSON=function(a,b,d){"function"==typeof b&&(d=b,b=null),CanvasEngine.ajax({url:a,dataType:"json",data:b,success:d})},CanvasEngine.parseJSON=function(a){return JSON.parse(a)},CanvasEngine.each=function(e,d){var b,a;if(e instanceof Array||"number"==typeof e)for(e instanceof Array?a=e.length:"number"==typeof e&&(a=e,e=[]),b=0;a>b;++b)d.call(e,b,e[b]);else for(b in e)d.call(e,b,e[b])},CanvasEngine.inArray=function(b,d){var a;for(a=0;a<d.length;++a)if(b==d[a])return a;return-1},CanvasEngine.clone=function(a){var d;if("object"!=typeof a||null==a)return a;var b=a.constructor();if(void 0===b)return a;for(d in a)b[d]=CanvasEngine.clone(a[d]);return b},CanvasEngine.hexaToRGB=function(h){function d(b){return"#"==b.charAt(0)?b.substring(1,7):b}var f,e,a;return f=parseInt(d(h).substring(0,2),16),e=parseInt(d(h).substring(2,4),16),a=parseInt(d(h).substring(4,6),16),[f,e,a]},CanvasEngine.rgbToHex=function(e,d,a){return((1<<24)+(e<<16)+(d<<8)+a).toString(16).slice(1)},CanvasEngine._getRandomColorKey=function(){var e=Math.round(255*Math.random()),d=Math.round(255*Math.random()),a=Math.round(255*Math.random());return CanvasEngine.rgbToHex(e,d,a)},CanvasEngine.random=function(b,a){return Math.floor(Math.random()*a+b)},CanvasEngine.mobileUserAgent=function(){var a=navigator.userAgent;return a.match(/(iPhone)/)?"iphone":a.match(/(iPod)/)?"ipod":a.match(/(iPad)/)?"ipad":a.match(/(BlackBerry)/)?"blackberry":a.match(/(Android)/)?"android":a.match(/(Windows Phone)/)?"windows phone":!1},CanvasEngine._benchmark={},CanvasEngine._interval_benchmark=60,CanvasEngine._freq_benchmark={},CanvasEngine.microtime=function(){var a=(new Date).getTime()/1e3;parseInt(a,10);return 1e3*a},CanvasEngine.benchmark=function(b){var a=this.microtime();this._benchmark[b]&&console.log("Performance "+b+" : "+(a-this._benchmark[b])+"ms"),this._benchmark[b]=a},CanvasEngine.objectSize=function(d){var a,b=0;for(a in d)d.hasOwnProperty(a)&&b++;return b},CanvasEngine.extend=function(b,a,d){return b||(b={}),a||(a={}),Kernel._extend(b,a,d)},"undefined"==typeof exports){var _ua=navigator.userAgent.toLowerCase(),_version=/(chrome|firefox|msie|version)(\/| )([0-9.]+)/.exec(_ua);CanvasEngine.browser={mozilla:/mozilla/.test(_ua)&&!/webkit/.test(_ua),webkit:/webkit/.test(_ua),opera:/opera/.test(_ua),msie:/msie/.test(_ua),version:_version?_version[3]:null,which:function(){var a;return CanvasEngine.each(["mozilla","webkit","opera","msie"],function(d,b){CanvasEngine.browser[b]&&(a=b)}),{ua:a,version:CanvasEngine.browser.version}}}}CanvasEngine.moveArray=function(f,e,d){var b,a;if(e=parseInt(e,10),d=parseInt(d,10),e!==d&&e>=0&&e<=f.length&&d>=0&&d<=f.length){if(a=f[e],d>e)for(b=e;d>b;b++)f[b]=f[b+1];else for(b=e;b>d;b--)f[b]=f[b-1];f[d]=a}return f},CanvasEngine.toTimer=function(e){var a=""+Math.floor(e/60/60),b=""+Math.floor(e/60%60),d=""+Math.floor(e%60);return 1==a.length&&(a="0"+a),1==b.length&&(b="0"+b),1==d.length&&(d="0"+d),{hour:a,min:b,sec:d}},CanvasEngine.algo={pascalTriangle:function(a){a=a||10;for(var f=[[1,1],[1,2,1]],b=a-f.length,e=f.length;b>=e;e++){f[e]=[1];for(var d=1;e>=d;d++)f[e][d]=f[e-1][d]+f[e-1][d-1];f[e][e+1]=1}return f}},CanvasEngine.toMatrix=function(h,g,a){for(var d=[],b=0,e=0;a>e;e++)for(var f=0;g>f;f++)d[f]||(d[f]=[]),d[f][e]=h[b],b++;return d},CanvasEngine.rotateMatrix=function(g,e){var a=[],f=[];if(e=e||"90","90"==e||"-90"==e)for(var b=0;b<g[0].length;b++){a[b]=[];for(var d=0;d<g.length;d++)a[b][d]=g[d][b]}if("-90"==e){for(var b=0,d=a.length-1;d>=0;d--)f[b]=a[d],b++;return f}if("180"==e)for(var d=0;d<g.length;d++)a[d]=g[d].reverse();return a};var _CanvasEngine=CanvasEngine;if("undefined"!=typeof exports&&(exports.Class=Class,exports.CanvasEngine=CanvasEngine),function(){for(var b=0,d=["ms","moz","webkit","o"],a=0;a<d.length&&!window.requestAnimationFrame;++a)window.requestAnimationFrame=window[d[a]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[d[a]+"CancelAnimationFrame"]||window[d[a]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(i,f){var e=(new Date).getTime(),g=Math.max(0,16-(e-b)),h=window.setTimeout(function(){i(e+g)},g);return b=e+g,h}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),"undefined"!=typeof Element)for(var prop,vendors=["ms","moz","webkit","o","khtml"],x=0;x<vendors.length&&!Element.prototype.requestFullScreen;++x)Element.prototype.requestFullScreen=Element.prototype[vendors[x]+"RequestFullScreen"],document.cancelFullScreen=document[vendors[x]+"CancelFullScreen"];Class.create("ModelClientClass",{create:function(b,d,a){d instanceof Array||(a=d,d=!1),a.events=d,Class.create(b,a)},"new":function(b){var a=Class["new"](b).extend({_methods:{},emit:function(f,i,k){if(i||(i=[]),"function"==typeof i&&(k=i),k&&this.on(f,k),this[f]){if(!(i instanceof Array)){var h=[];for(var g in i)h.push(i[g]);i=h}var e=this[f].apply(this,i);this.call(f,e)}},on:function(e,f){this._methods[e]||(this._methods[e]={}),this._methods[e].callback=f},call:function(e,f){this._methods[e]&&this._methods[e].callback(f)}});if(this.events)for(var d in this.events)obj=a[events[d]],obj&&obj.on(this.events[d],function(e){e||(e={}),obj.call(a,e)});return a}});var Model=Class["new"]("ModelClientClass"),Global_CE;CanvasEngine.io=null,CanvasEngine.socketIO=function(){if("undefined"==typeof io)throw"Please add socket.io - http://socket.io";return io},CanvasEngine.User={autoAuthentication:function(g,h){CanvasEngine.socketIO(),"string"!=typeof g&&(h=g,g="canvasengine");var b,d=new RegExp(g+"=({.*?})","i"),a=document.cookie.match(d);if(a&&a[1])try{b=JSON.parse(a[1]),CanvasEngine.io.emit("_autoAuthentication",{session:b.session_id}),CanvasEngine.io.on("_autoAuthentication",function(e){"success"==e.ret&&h.success?h.success():"failed"==e.ret&&h.failed&&h.failed(e.err)})}catch(f){console.warn("Error session format in cookie ; ",f.stack)}},_setCookie:function(e,f){var b=void 0==f;e=e||"canvasengine";var d=new Date;d.setTime(d.getTime()+24*(b?-1:2)*60*60*1e3);var a="; expires="+d.toGMTString();document.cookie=e+"="+(b?"":JSON.stringify(f))+a+"; path=/"},authentication:function(e,b,d){var a=this;CanvasEngine.socketIO(),CanvasEngine.io.emit("_authentication",{username:e,password:b}),CanvasEngine.io.on("_authentication",function(f){"success"==f.ret&&d.success?(a._setCookie(d.cookie_name,{session_id:f.session_id}),d.success()):"failed"==f.ret&&d.failed&&d.failed(f.err)})},register:function(d,a,b){CanvasEngine.socketIO(),CanvasEngine.io.emit("_register",{username:d,password:a,data:b.data}),CanvasEngine.io.on("_register",function(e){"success"==e.ret&&b.success?b.success():"failed"==e.ret&&b.failed&&b.failed(e.err)})},logout:function(b){b=b||{};CanvasEngine.socketIO(),CanvasEngine.io.emit("_logout"),this._setCookie(b.cookie_name)},isLogged:function(){}},CanvasEngine.connectServer=function(b,a){CanvasEngine.socketIO(),CanvasEngine.io=io.connect(b+":"+a)},CanvasEngine.defines=function(a,d){d=d||{},void 0===d.render&&(d.render=!0),"string"==typeof a&&(a=[a]);var b;return Class.create("CanvasEngineClass",{_noConflict:!1,initialize:function(e){this.canvas=a,this.el_canvas=[]},ready:function(g){function f(){for(var h=0;h<e.canvas.length;h++)e.el_canvas.push(e.Canvas["new"](e.canvas[h]));d.render&&b.Scene._loop(e.el_canvas),g&&g()}var e=this;return b.Sound._manager="undefined"!=typeof soundManager,b.Sound._manager?soundManager.setup(_CanvasEngine.extend({url:d.swf_sound?d.swf_sound:"swf/",onready:f},d.soundmanager)):g?window.onload=f:f(),this},plugins:function(){},mouseover:!1,noConflict:function(){this._noConflict=!0},Materials:{images:{},_buffer:{},_cache_canvas:{},sounds:{},videos:{},fonts:{},data:{},get:function(f,e){if(e)return this[e+"s"][f];if(_m=this.images[f]||this.sounds[f]||this.videos[f]||this.data[f])return _m;if(f instanceof Image||f instanceof HTMLCanvasElement||f instanceof HTMLVideoElement||f instanceof HTMLAudioElement)return f;if(d.ignoreLoadError)return!1;throw'Cannot to get the data "'+f+'" because it does not exist'},imageToCanvas:function(m,l){if(l=l||{},this._cache_canvas[m]&&l.cache)return this._cache_canvas[m];var i,f,g=this.get(m);if(g){var e=l.width||g.width,k=l.height||g.height,i=document.createElement("canvas");return i.width=e,i.height=k,f=i.getContext("2d"),f.drawImage(g,0,0,g.width,g.height,0,0,e,k),this._cache_canvas[m]={canvas:i,ctx:f},this._cache_canvas[m]}},createBuffer:function(e){var g="_opaque_"+e,f=this.get(e,"video")||e instanceof HTMLVideoElement;return f?f:(this._buffer[g]||(this._buffer[g]=this.opaqueImage(e)),this._buffer[g])},transparentColor:function(g,o,f){var e,q,t,r=this.imageToCanvas(g,{cache:f}),h=r.canvas,v=r.ctx;e=v.getImageData(0,0,h.width,h.height),q=e.data,t=_CanvasEngine.hexaToRGB(o);for(var p=0,k=q.length;k>p;p+=4){var l=q[p],m=q[p+1],u=q[p+2];l==t[0]&&m==t[1]&&u==t[2]&&(q[p+3]=0)}return v.putImageData(e,0,0),h},invertColor:function(n,f){var m,l,k=this.imageToCanvas(n),g=k.canvas,e=k.ctx;m=e.getImageData(0,0,g.width,g.height),l=m.data;for(var h=0;h<l.length;h+=4)l[h]=255-l[h],l[h+1]=255-l[h+1],l[h+2]=255-l[h+2];return e.putImageData(m,0,0),g},cropImage:function(f,o,n,p,k){var e,l=this.imageToCanvas(f);if(l){var g=l.canvas,q=l.ctx;return e=q.getImageData(o,n,p,k),g.width=p,g.height=k,q.putImageData(e,0,0),g}},opaqueImage:function(k){var h=this.imageToCanvas(k),f=h.canvas,e=h.ctx;imageData=e.getImageData(0,0,f.width,f.height),data=imageData.data;for(var g=0;g<data.length;g+=4)data[g+3]>0&&(data[g+3]=255);return e.putImageData(imageData,0,0),f},getExtension:function(e){return/[.]/.exec(e)?/[^.]+$/.exec(e)[0]:void 0},getBasePath:function(g,e){var f=g.substring(0,g.lastIndexOf("/"));return""!=f&&e?f+"/":f},getFilename:function(g,e){var f=g.replace(/^.*[\\\/]/,"");return e?f:(f=f.split("."),f.slice(0,f.length-1).join("."))},Transition:{_data:{},set:function(n,l){var m,h,e=[];if(this._data[n])return this._data[n];if(n instanceof Array)e=l;else{var k=b.Materials.imageToCanvas(n,{width:1024,height:768});"undefined"!=typeof Uint8ClampedArray&&(e=new Uint8ClampedArray(k.canvas.width*k.canvas.height)),m=k.ctx.getImageData(0,0,k.canvas.width,k.canvas.height),h=m.data;for(var f=0,g=0;g<h.length;g+=4)e[f]=h[g],f++}return this._data[n]=e,e},get:function(e){return this._data[e]}},load:function(o,y,q,n){function r(){var i;u[h]?(i=new Image,i.onload=function(){var p;u[h].transparentcolor&&(p=v.transparentColor(i,u[h].transparentcolor)),p=u[h].invertcolor?v.invertColor(i):i,v.images[u[h].id]=p,u[h].transition&&v.Transition.set(u[h].id),q&&q.call(v,p,u[h]),h++,r()},i.onerror=function(p){d.ignoreLoadError&&(q&&q.call(v,p),h++,r())},i.src=u[h].path):n&&n.call(v)}function k(){function D(){q&&q.call(v,this,u[h]),h++,k()}if(u[h])if(v.sounds[u[h].id])D();else if(b.Sound._manager)v.sounds[u[h].id]=soundManager.createSound({id:u[h].id,url:u[h].path,autoLoad:!0,autoPlay:!1,onload:D,onfinish:function(){this._loop&&this.play()}});else{var B=new Audio,p=u[h].path,z=v.getBasePath(p),i=v.getFilename(p),A=v.getExtension(p),F={mp3:B.canPlayType("audio/mpeg"),ogg:B.canPlayType('audio/ogg; codecs="vorbis"'),m4a:B.canPlayType('audio/mp4; codecs="mp4a.40.2"')};if(!F[A])for(var E in F)if(A!=E&&F[E]){p=z+"/"+i+"."+E;break}B.setAttribute("src",p),B.addEventListener("canplaythrough",function(){v.sounds[u[h].id]=this,D()},!1),B.addEventListener("ended",function(){this._loop&&(this.currentTime=0,this.play())},!1),B.addEventListener("error",function(G){d.ignoreLoadError&&D()},!1),B.load(),B.pause(),document.body.appendChild(B),/^i/.test(_CanvasEngine.mobileUserAgent())&&(v.sounds[u[h].id]=B,D())}else n&&n.call(v)}function f(){var i=u[h];if(i){if("google"==i.id||"ascender"==i.id||"typekit"==i.id||"monotype"==i.id||"fontdeck"==i.id){var B={};B[i.id]=i,i._id&&(B[i.id].id=i._id),"undefined"==typeof WebFontConfig&&(WebFontConfig={}),WebFontConfig=_CanvasEngine.extend(WebFontConfig,B)}else{var z=document.createElement("style"),A=v.getBasePath(i.path,!0)+v.getFilename(i.path)+"."+(_CanvasEngine.browser.msie?"eot":"ttf");z.innerHTML="@font-face { font-family: '"+i.id+"'; src: url('"+A+"'); font-weight: normal; font-style: normal;}",document.getElementsByTagName("head")[0].appendChild(z)}h++,q&&q.call(v,this,u[h]),f()}else{if(!document.getElementById("google-webfont")){var p=document.createElement("script");p.src=("https:"==document.location.protocol?"https":"http")+"://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js",p.type="text/javascript",p.async="true",p.id="google-webfont";var z=document.getElementsByTagName("script")[0];z.parentNode.insertBefore(p,z)}n&&n.call(v)}}function m(){function A(){q&&q.call(v,this,u[h]),h++,m()}function i(B){window.stream=B,window.URL?z.src=window.URL.createObjectURL(B):z.src=B,v.videos[u[h].id]=z,A()}function p(B){throw"navigator.getUserMedia error: "+B}if(u[h]){var z=document.createElement("video");u[h].webcam?(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,navigator.getUserMedia(u[h].webcam,i,p)):(z.src=u[h].path,z.addEventListener("loadeddata",function(B){z.width=(B.srcElement||B.target).videoWidth,z.height=(B.srcElement||B.target).videoHeight,v.videos[u[h].id]=z,A()},!1),z.onerror=function(B){if(!d.ignoreLoadError)throw"Video error #"+B.target.error.code+": See http://dev.w3.org/html5/spec-author-view/video.html#dom-mediaerror-media_err_aborted";A()},z.load()),document.body.appendChild(z),z.setAttribute("style","display:none;")}else n&&n.call(v)}function l(){function i(){q&&q.call(v,this,u[h]),h++,l()}u[h]?_CanvasEngine.ajax({url:u[h].path,dataType:"json",success:function(p){v.data[u[h].id]=p,i()},error:function(){d.ignoreLoadError&&i()}}):n&&n.call(v)}var e,w,h=0,v=this,u=[];y instanceof Array||(y=[y]);for(var g=0;g<y.length;g++)if(e=y[g],e.id)u.push(e);else for(var t in e)w={},w=_CanvasEngine.extend({},e[t]),"string"==typeof e[t]&&(w.path=e[t]),w.id&&(w._id=w.id),w.id=t,u.push(w),void 0!=w.index&&_CanvasEngine.moveArray(u,u.length-1,w.index);switch(o){case"images":r();break;case"sounds":k();break;case"fonts":f();break;case"videos":m();break;case"data":l()}}},Sound:{_fade:{},_manager:!1,get:function(f){var e=b.Materials.get(f,"sound");return e},allStop:function(g){g=g||"";var e=b.Materials.sounds;for(var f in e)f!=g&&this.stop(f);return this},stop:function(f){var e=this.get(f);return d.soundmanager?e.stop():(e.currentTime=0,e.pause()),e._loop=!1,this},play:function(e){return this.get(e).play(),this},playOnly:function(e){return this.allStop(e),this.get(e).play(),this},playLoop:function(f){var e=this.get(f);return e._loop=!0,e.play(),this},fadeIn:function(g,e,f){this.fadeTo(g,e,1,f)},fadeOut:function(g,e,f){this.fadeTo(g,e,0,f)},fadeTo:function(k,g,i,h){var f=this.get(k),e=this._manager?f.volume/100:f.volume;this._fade[k]={sound:f,init:e,c_volume:e,f_time:g,to:i,callback:h}},_loop:function(){var g,f;for(var e in this._fade)if(g=this._fade[e],f=!1,g&&(g.init<g.to?(g.c_volume>=g.to?(g.c_volume=g.to,f=!0):g.c_volume+=Math.abs(g.to-g.init)/g.f_time,g.c_volume>.999&&(g.c_volume=1)):(g.c_volume<=g.to?(g.c_volume=g.to,f=!0):g.c_volume-=Math.abs(g.to-g.init)/g.f_time,g.c_volume<.001&&(g.c_volume=0)),this._manager?g.sound.setVolume(100*g.c_volume):g.sound.volume=g.c_volume,f)){g.callback&&g.callback.call(g.sound),delete this._fade[e];break}}},Canvas:{"new":function(e){return Class["new"]("Canvas",[e])}},Element:{"new":function(h,f,g,e){return Class["new"]("Element",[h,f,g,e])}},Context:{"new":function(e){return Class["new"]("Context",[e])}},Scene:{_scenes:{},_cacheScene:{},_scenesEnabled:{},_scenesIndex:[],_scenesNbCall:{},_current:null,New:function(){return this["new"].apply(this,arguments)},"new":function(f){var e;if("string"==typeof f){if(!this._cacheScene[f])throw"Please initialize '"+f+"' scene with an object before";f=this._cacheScene[f]}else this._cacheScene[f.name]=f;return e=Class["new"]("Scene",[f]).extend(f,!1),this._scenesNbCall[f.name]=0,this._scenes[f.name]=e,e},call:function(g,h){this._scenesNbCall[g]>0&&this.New(g);var e=this._scenes[g],f=[g];if(h=h||{},!e)throw'Scene "'+g+"\" doesn't exist";return this._scenesEnabled[g]=e,-1==this._scenesIndex.indexOf(g)&&(h.transition?this._scenesIndex=f.concat(this._scenesIndex):this._scenesIndex.push(g)),h.exitScenes?(h.exitScenes.allExcept=h.exitScenes.allExcept||[],h.exitScenes.allExcept=f.concat(h.exitScenes.allExcept),e._load.call(e,h.exitScenes,h.params)):(h.overlay||h.transition||this.exitAll(f),e._load.call(e,h,h.params)),this._scenesNbCall[g]++,e},exit:function(f){var e=this._scenesEnabled[f],h=e.getCanvas();if(e){h._layerDOM&&(h._layerDOM.innerHTML=""),e._exit.call(e);for(var g=0;g<this._scenesIndex.length;g++)if(this._scenesIndex[g]==f){this._scenesIndex.splice(g,1);break}delete this._scenesEnabled[f]}},isEnabled:function(e){return!!this._scenesEnabled[e]},exitAll:function(f){var e;f instanceof Array||(f=[f]);for(e in this._scenesEnabled)_CanvasEngine.inArray(e,f)&&this.exit(e)},exist:function(e){return!!this._scenes[e]},get:function(e){return this._scenes[e]},getEnabled:function(){return this._scenesEnabled},_loop:function(h){function e(){var m=0;for(k=((new Date).getTime()-l)/1e3,l=(new Date).getTime(),f.fps=1/k,b.Sound._loop(),h[m].clear(),h[m]._ctxMouseEvent.clearRect(0,0,h[m].width,h[m].height),g=0;g<f._scenesIndex.length;g++)i=f._scenesEnabled[f._scenesIndex[g]],i&&i._loop();requestAnimationFrame(e)}var g,i,f=this;this.fps=0;var k,l=(new Date).getTime();requestAnimationFrame(e)},getFPS:function(){return~~this.fps},getPerformance:function(){return~~(this.getFPS()/60*100)}}}),Class.create("Canvas",{id:null,element:null,stage:null,ctx:null,_globalElements:{},_ctxTmp:null,_layerDOM:null,_layerParent:null,_ctxMouseEvent:null,_canvasMouseEvent:null,width:0,height:0,mouseEvent:!0,initialize:function(f){function o(h){p.addEventListener(h,function(i){t(i,h)},!1)}function e(h){n.on(h,function(i){t(i,h)})}function t(C,A){var B,w,h=b.Scene.getEnabled();B=C.gesture?C.gesture.touches:[v.getMousePosition(C)];for(var i in h){w=h[i].getStage();for(var z=0;z<B.length;z++){if(k=B[z],void 0!==k.pageX&&(k=v.getMousePosition(k)),"mousemove"==A){if(!v.mouseEvent)continue;w._mousemove(C,k)}w.trigger(A,[C,k]),w._select(k,function(D){D.trigger(A,[C,k])})}}}var r,m,v=this;this.id=f;var g=this._getElementById(f);"CANVAS"!=g.tagName&&"canvas"!=g.tagName?(this.element=document.createElement("canvas"),this._layerDOM=document.createElement("div"),r=this.element.width=g.getAttribute("width"),m=this.element.height=g.getAttribute("height"),this.element.style.position="absolute",g.style.position=this._layerDOM.style.position="relative",g.style.width=r+"px",g.style.height=m+"px",g.style.overflow=this._layerDOM.style.overflow="hidden",this._layerDOM.style.width=this._layerDOM.style.height="100%",g.appendChild(this.element),g.appendChild(this._layerDOM),this._layerParent=g):this.element=g,this.width=this.element.width,this.height=this.element.height,this.ctx=this.element.getContext("2d"),this.hammerExist="undefined"!=typeof Hammer,this._mouseEvent();var k,u=["click","dbclick","mousemove","mousedown","mouseup"],q=["dragstart","drag","dragend","dragup","dragdown","dragleft","dragright","swipe","swipeup","swipedown","swipeleft","swiperight","rotate","pinch","pinchin","pinchout","tap","doubletap","hold","transformstart","transform","transformend","release","touch","release"],p=this._layerParent||this.element,n=null;if(this.hammerExist&&(n=new Hammer(p)),n)for(var l=0;l<q.length;l++)e.call(this,q[l]);for(var l=0;l<u.length;l++)o.call(this,u[l]);d.contextmenu||p.addEventListener("contextmenu",function(h){h.preventDefault()})},_elementsByScene:function(e,f,g){return this._globalElements[e]||(this._globalElements[e]={}),g?void(this._globalElements[e][f]=g):f?this._globalElements[e][f]:this._globalElements[e]},_getElementById:function(f){var e;return d.cocoonjs?(e=document.createElement("canvas"),e.width=d.cocoonjs.width,e.height=d.cocoonjs.height,e.id=f,document.body.appendChild(e)):e=document.getElementById(f),e},_mouseEvent:function(){this._canvasMouseEvent=document.createElement("canvas"),this._canvasMouseEvent.width=this.width,this._canvasMouseEvent.height=this.height,this._ctxMouseEvent=this._canvasMouseEvent.getContext("2d")},canvasReady:function(){},getMousePosition:function(l){for(var k=this.element,i=0,h=0;k&&"BODY"!=k.tagName;)i+=k.offsetTop,h+=k.offsetLeft,k=k.offsetParent;void 0==l.clientX&&(l.clientX=l.pageX),void 0==l.clientY&&(l.clientY=l.pageY),window.pageXOffset||(window.pageXOffset=0),window.pageYOffset||(window.pageYOffset=0);var g=l.clientX-h+window.pageXOffset,f=l.clientY-i+window.pageYOffset;return{x:g,y:f}},measureText:function(f,e,g){var i;if(/[ ]+/.test(e)){var h=e.split(" ");e=h[0],g=h[1]}return g=g||"Arial",e=e||"12px",this.ctx.font="normal "+e+" "+g,i=this.ctx.measureText(f),this.ctx.font=null,{width:i.width,height:this._measureTextHeight(f,e,g)}},_measureTextHeight:function(h,f,k){var n=this.ctx;n.save(),n.translate(0,Math.round(.8*this.height)),n.font="normal "+f+" "+k,n.fillText(h,0,0),n.restore();for(var g=n.getImageData(0,0,this.width,this.height).data,i=!1,m=!1,e=this.height,l=0;!m&&e;)for(e--,l=0;l<this.width;l++)if(g[e*this.width*4+4*l+3]){m=e;break}for(;e;){for(e--,l=0;l<this.width;l++)if(g[e*this.width*4+4*l+3]){i=e;break}if(i!=e)return m-i}return 0},createPattern:function(f,e){e=e||"repeat";var g=b.Materials.get(f);if(g)return this.ctx.createPattern(g,e)},createLinearGradient:function(f,h,e,g){return this.ctx.createLinearGradient(f,h,e,g)},createRadialGradient:function(h,k,g,f,i,e){return this.ctx.createRadialGradient(h,k,g,f,i,e)},addColorStop:function(f,e){return this.ctx.addColorStop(f,e)},getImageData:function(e,i,f,g){return e||(e=0,i=0),f||(f=this.width,g=this.height),this.ctx.getImageData(e,i,f,g)},putImageData:function(h,g,l,f,k,e,i){return g||(g=0,l=0),this.ctx.putImageData(h,g,l,f,k,e,i)},createImageData:function(){return this.ctx.createImageData.apply(this.ctx,arguments)},toDataURL:function(){return this.ctx.toDataURL()},clear:function(){return this.ctx.clearRect(0,0,this.width,this.height)},cursor:function(e){this.element.style.cursor=e},isFullscreen:function(){return document.fullscreen||document.mozFullScreen||document.webkitIsFullScreen},setSize:function(e,m,g){var i,n=this,l=this.element.width,h=this.element.height,k=e;if("reset"==e?(e=this.width=this._oldSize.width,m=this.height=this._oldSize.height,this._canvasMouseEvent.style.width=this._canvasMouseEvent.style.height=this.element.style.width=this.element.style.height=null,"browser"==this._oldSize.type?this.element.style.position=this.element.style.top=this.element.style.left=null:"fullscreen"==this._oldSize.type&&document.cancelFullScreen()):"fullscreen"==e&&(g=m,e=screen.width,m=screen.height,this.element.requestFullScreen?this.element.requestFullScreen():e=k="browser"),"browser"==e){g=m,e=window.innerWidth,m=window.innerHeight;var f=this.element;this._layerParent&&(f=this._layerParent),f.style.position="fixed",f.style.top=f.style.left="50%",window.onresize=function(o){"browser"==k&&n.setSize("browser",g)}}return"fit"==g?(i=l/h,e=m*i,this._canvasMouseEvent.style.width=this.element.style.width=e+"px",this._canvasMouseEvent.style.height=this.element.style.height=m+"px"):"stretch"==g?(this._canvasMouseEvent.style.width=this.element.style.width=e+"px",this._canvasMouseEvent.style.height=this.element.style.height=m+"px"):(this._canvasMouseEvent.width=this.width=this.element.width=e,this._canvasMouseEvent.height=this.height=this.element.height=m),"browser"==k&&(f.style.margin=-m/2+"px 0 0 "+-e/2+"px"),this._layerParent&&(this._layerParent.style.width=e+"px",this._layerParent.style.height=m+"px"),this._oldSize={width:l,height:h,type:k},this}}),Class.create("Scene",{id:0,_stage:{},_events:[],_pause:!1,_isReady:!1,_index:0,model:null,initialize:function(g){this.id=_CanvasEngine.uniqid(),this._events=g.events},_loop:function(){this._pause?this._stage.refresh():this._isReady&&this.render?this.render.call(this,this._stage):this._stage.refresh()},emit:function(e,f){this.model.call(e,f)},getElement:function(e){return this._global_elements[e]?this._global_elements[e]:this.createElement(e)},pause:function(e){return void 0===e?this._pause:(this._pause=e,this)},togglePause:function(){return this.pause(!this._pause)},getStage:function(){return this._stage},getCanvas:function(e){return e||(e=0),b.el_canvas[e]},zIndex:function(f){var e;return void 0===f?this._index:(f instanceof Class&&(f=f.zIndex()),e=b.Scene._scenesIndex.length,Math.abs(f)>=e&&(f=-1),0>f&&(f=e+f),_CanvasEngine.moveArray(b.Scene._scenesIndex,this._index,f),this._index=f,this)},createElement:function(f,k,e){if(f instanceof Array){for(var l={},g=0;g<f.length;g++)l[f[g]]=this.createElement(f[g]);return l}"string"!=typeof f&&(e=k,k=f);var h=b.Element["new"](this,null,k,e);return h.name=f,h},_exit:function(){this.getCanvas()._elementsByScene[this.name]={},this.exit&&this.exit.call(this)},loadEvents:function(){var e=this;_CanvasEngine.io&&this._events&&_CanvasEngine.each(this._events,function(f,g){_CanvasEngine.io.on(e.name+"."+g,function(h){e[g]&&b.Scene.isEnabled(e.name)&&e[g].call(e,h)})})},_load:function(h,v){function p(i){b.Materials.load(i,u.materials[i],function(y,w){q(y,w,i)})}function q(y,w,i){m++,u.preload&&u.preload(u._stage,m/r*100,{material:y,type:i,index:m,data:w}),r==m&&t()}function o(z){var y=0;if(!u.materials)return 0;if(u.materials[z])for(var w in u.materials[z])y++;return y}function t(){"afterPreload"==h.when&&b.Scene.exitAll(h.allExcept),u.ready&&u.ready(u._stage,v),u._stage.trigger("canvas:readyEnd"),u.model&&u.model.ready&&u.model.ready.call(u.model),u._isReady=!0,h.transition&&(h.transition===!0&&(h.transition={type:"fade"}),u.execTransition(h.transition.type,h.transition,h.overlay))}var u=this;h=h||{},v=v||{},this._stage=b.Element["new"](this),this._stage._dom=this.getCanvas()._layerDOM,this._stage._name="__stage__",this._index=b.Scene._scenesIndex.length-1;for(var k=0;k<b.el_canvas.length;k++)b.el_canvas[k].stage=this._stage;this.model&&this._events&&CE.each(this._events,function(w,y){u.model.on(y,function(i){u[y].call(u,i)})}),this.loadEvents(),this.called&&this.called(this._stage);var n=o("images"),e=o("sounds"),g=o("fonts"),l=o("videos"),f=o("data"),r=n+e+g+l+f,m=0;n>0&&p("images"),e>0&&p("sounds"),g>0&&p("fonts"),l>0&&p("videos"),f>0&&p("data"),0==n&&0==e&&0==g&&0==l&&0==f&&t()},execTransition:function(p,l,h){var o,r=this;l=l||{},l=_CanvasEngine.extend({frames:30},l);var n,f=b.Scene.getEnabled(),m=0;for(var t in f)if(f[t].id!=this.id)switch(n=f[t].getStage(),o=f[t].getCanvas(),p){case"fade":if(!b.Timeline)throw"Add the Timeline class for transitions";b.Timeline.New(n).to({opacity:0},l.frames).call(function(){h||b.Scene.exitAll(r.name),l.finish&&l.finish.call(r),f[t].zIndex(0)});break;case"image":var o=n.buffer(o.width,o.height),q=o.getContext("2d"),i=0,g=new Worker("workers/transition.js");g.addEventListener("message",function(k){0==i&&n.empty(),q.putImageData(k.data.imageData,0,0),n.drawImage(o),i++,k.data.finish&&(g.terminate(),l.finish&&l.finish.call(r),h||b.Scene.exitAll(r.name))});var e=q.getImageData(0,0,o.width,o.height);g.postMessage({imgData:e,pattern:b.Materials.Transition.get(l.id)}),n.on("canvas:refresh",function(k){g.postMessage("")}),m++}}}),Class.create("Context",{_cmd:{},_graphicCmd:[],_graphicPointer:0,img:{},_useClip:!1,globalAlpha:1,_PROPS:["shadowColor","shadowBlur","shadowOffsetX","shadowOffsetY","globalAlpha","globalCompositeOperation","lineJoin","lineCap","lineWidth","miterLimit","fillStyle","font","textBaseline","textAlign","strokeStyle"],multiple:!1,alpha:function(e){},_setMethod:function(f,g){var e=this;this[f]=function(){var h="cmd"==g?"_addCmd":"draw";e[h](f,arguments)}},_defaultRectParams:function(e,m,f,i,l,k){var g=arguments[arguments.length-1];return arguments=Array.prototype.slice.call(arguments,0,arguments.length-1),"string"==typeof arguments[0]&&(this[g]=e,e=m,m=f,f=i,i=l,l=k),void 0==arguments[0]&&(e=0,m=0),void 0==arguments[3]&&(f=this.width,i=this.height),[e,m,f,i,l]},fillRect:function(e,l,f,i,k){var g=Array.prototype.slice.call(arguments,0);return g=this._defaultRectParams.apply(this,g.concat("fillStyle")),"string"!=typeof e&&void 0!==k?void this._roundRect.apply(this,g.concat("fill")):(this._addCmd("fillRect",g,["fillStyle"]),this)},strokeRect:function(e,l,f,i,k){var g=Array.prototype.slice.call(arguments,0);return g=this._defaultRectParams.apply(this,g.concat("strokeStyle")),"string"!=typeof e&&void 0!==k?(this._roundRect.apply(this,g.concat("stroke")),this):(this._addCmd("strokeRect",g,["strokeStyle"]),this)},fillCircle:function(e,g,f){return this._circle(e,g,f,"fill"),this},strokeCircle:function(e,g,f){return this._circle(e,g,f,"stroke"),this},_circle:function(e,h,g,f){void 0===h&&(g=e),e=e||0,h=h||0,g=g||this.width/2,isNaN(g)&&console.warn(f+"Circle() : Impossible to define the radius of the circle. Give a width to the element"),
this.strokeStyle||(this.strokeStyle="black"),this.beginPath(),this.arc(e,h,g,0,2*Math.PI,!1),this[f]()},_roundRect:function(e,l,f,i,k,g){2*k>f&&(k=f/2),2*k>i&&(k=i/2),this.beginPath(),this.moveTo(e+k,l),this.arcTo(e+f,l,e+f,l+i,k),this.arcTo(e+f,l+i,e,l+i,k),this.arcTo(e,l+i,e,l,k),this.arcTo(e,l,e+f,l,k),this.closePath(),this[g]()},fill:function(){return this._addCmd("fill",[],["fillStyle"]),this},fillText:function(g,e,h){if("middle"==e&&this.width&&this.height){var f=this.scene.getCanvas().measureText(g,this.font).width;this.textBaseline="middle",e=this.width/2-f/2,h=this.height/2}return e||(e=0),h||(h=0),this._addCmd("fillText",[g,e,h],["fillStyle","font","textBaseline","textAlign"]),this},strokeText:function(f,e,g){return this._addCmd("strokeText",[f,e,g],["strokeStyle","font","textBaseline","textAlign"]),this},stroke:function(){return this._addCmd("stroke",[],["strokeStyle"]),this},drawImage:function(i,p,o,q,k,t,r,e,n){var l,f,h,m=i;if(p||(p=0),o||(o=0),"string"==typeof i){if(m=b.Materials.get(i),!m)return;this.img.width=m.width,this.img.height=m.height}/%$/.test(q)&&(t=p,r=o,p=0,o=0,q=m.width*parseInt(q)/100,k=m.height,e=q,n=k);var g=new RegExp("^"+window.location.origin,"g");return h=g.test(m.src)?b.Materials.createBuffer(i):m,void 0!==q?(void 0===t?(l=[m,p,o,q,k],f=[h,p,o,q,k]):(l=[m,p,o,q,k,t,r,e,n],f=[h,p,o,q,k,t,r,e,n]),this._buffer_img={params:f,x:t,y:r,width:e,height:n}):(l=[m,p,o],f=[h,p,o],this._buffer_img={params:f,x:p,y:o,width:m.width,height:m.height}),this._addCmd("drawImage",l),this},moveTo:function(){return this._addCmd.call(this,"moveTo",arguments,!0),this},lineTo:function(){return this._addCmd.call(this,"lineTo",arguments,!0),this},quadraticCurveTo:function(){return this._addCmd.call(this,"quadraticCurveTo",arguments,!0),this},bezierCurveTo:function(){return this._addCmd.call(this,"bezierCurveTo",arguments,!0),this},beginPath:function(){return this.multiple=!0,this._graphicCmd.push([]),this._addCmd.call(this,"beginPath",arguments),this},closePath:function(){return this._addCmd.call(this,"closePath",arguments,!0),this},clip:function(){return this._useClip=!0,this._addCmd.call(this,"clip",arguments),this},rect:function(){var e=Array.prototype.slice.call(arguments,0);return e=this._defaultRectParams.apply(this,e.concat("fillStyle")),this._addCmd("rect",e),this},arc:function(){return this._addCmd.call(this,"arc",arguments,!0),this},arcTo:function(){return this._addCmd.call(this,"arcTo",arguments,!0),this},addColorStop:function(){return this._addCmd.call(this,"addColorStop",arguments,!0),this},isPointInPath:function(){return this._addCmd.call(this,"isPointInPath",arguments,!0),this},rotate:function(){return this.draw.call(this,"rotate",arguments),this},translate:function(){return this.draw.call(this,"translate",arguments),this},transform:function(){return this.draw.call(this,"transform",arguments),this},setTransform:function(){return this.draw.call(this,"setTransform",arguments),this},resetTransform:function(){return this.draw.call(this,"resetTransform",arguments),this},clearRect:function(){return this.draw.call(this,"clearRect",arguments),this},scale:function(){return this.draw.call(this,"scale",arguments),this},rotateDeg:function(e){this.rotate(e*Math.PI/180)},save:function(e){e?this._addCmd("save"):this.draw("save")},restore:function(e){e?this._addCmd("restore"):this.draw("restore")},clearPropreties:function(){for(var f=this._PROPS,e=0;e<f.length;e++)this[f[e]]&&(this[f[e]]=void 0)},_bufferEvent:function(f,e){var g=this._canvas[0]._ctxMouseEvent;(this.hasEvent()||this._useClip)&&("drawImage"!=f||this._forceEvent?g[f].apply(this._canvas[0]._ctxMouseEvent,e):(g[f].apply(this._canvas[0]._ctxMouseEvent,this._buffer_img.params),g.globalCompositeOperation="source-atop",g.fillStyle="#"+this.color_key,g.fillRect(this._buffer_img.x,this._buffer_img.y,this._buffer_img.width,this._buffer_img.height)))},draw:function(z,u,w){function f(C,g){for(var A=0;A<this._canvas.length;A++){if(e=C.propreties,v&&"restore"==g&&this.clearPropreties(),e)for(var B in e)k=1,"globalAlpha"==B&&(e[B]=this.real_opacity),m?m[B]=e[B]:this._canvas[A][y][B]=e[B],k&=r.call(this,e,"globalAlpha",1),k&=r.call(this,e,"strokeStyle","#"+this.color_key),k&=r.call(this,e,"fillStyle","#"+this.color_key),k&&r.call(this,e,B,e[B]);m?m[g].apply(m,C.params):(this._canvas[A][y][g].apply(this._canvas[A][y],C.params),this._forceEvent&&"rect"==g&&this._bufferEvent("fillRect",C.params),this._bufferEvent(g,C.params))}}this._graphicPointer=0;var m,y="ctx";u||(u=[]),w||(w={});var p,m=this.getScene().getCanvas()._ctxTmp,i={},e={},v=!0,k=1,r=function(B,g,A){return B[g]||this._forceEvent?(this._canvas[0]._ctxMouseEvent[g]=A,0):1};z&&"string"!=typeof z&&(m=z,z=null),z?(i[z]=[{params:u,propreties:w}],v=!1):i=this._cmd;var t,q;for(var l in i)for(var h in i[l])if(p=i[l][h],f.call(this,p,l),"beginPath"==l){t=this._graphicCmd[this._graphicPointer];for(var o=0;o<t.length;o++)q=t[o],f.call(this,q,q.name);this._graphicPointer++}},_addCmd:function(g,l,e,n){"boolean"==typeof e&&(n=e,e=!1),l=l||[],e=e||[];var m=this._PROPS;e=e.concat(m);for(var i={},f=0;f<e.length;f++)this[e[f]]&&(i[e[f]]=this[e[f]]);if(i.globalAlpha=1,n){var h=this._graphicCmd[this._graphicCmd.length-1];if(!h)throw"error";h.push({name:g,params:l,propreties:i})}else this.multiple&&"undefined"!=typeof this._cmd[g]&&null!==this._cmd[g]?this._cmd[g].push({params:l,propreties:i}):this._cmd[g]=[{params:l,propreties:i}]},hasCmd:function(e){return void 0!==this._cmd[e]},removeCmd:function(e){"clip"==e&&(this._useClip=!1),delete this._cmd[e]}}),Class.create("Element",{_children:[],_attr:{},x:0,y:0,real_x:0,real_y:0,real_scale_x:1,real_scale_y:1,real_rotate:0,real_skew_x:0,real_skew_y:0,real_opacity:1,real_propagation:!0,scaleX:1,scaleY:1,skewX:0,skewY:0,opacity:1,rotation:0,width:null,height:null,regX:0,regY:0,parent:null,pause:!1,_index:0,_id:null,_visible:!0,_listener:{},_buffer_img:null,_out:1,_over:0,_nbEvent:0,_onRender:[],_pack:null,_useDOM:!1,_forceEvent:!1,propagationOpacity:null,initialize:function(l,h,i,e){var f=l.getCanvas();this._id=_CanvasEngine.uniqid(),this._dom=document.createElement("div"),this.width=i,this.height=e,this.scene=l,this.stage=l._stage,this.layer=h;var g,k=f._elementsByScene(this.scene.name);do g=_CanvasEngine._getRandomColorKey();while(g in k);this.color_key=g,this.scene.getCanvas()._elementsByScene(this.scene.name,g,this),this._canvas=b.el_canvas},_initParams:function(e){!e&&this.parent||(this.parent={scaleX:1,scaleY:1,real_x:0,real_y:0,real_scale_x:1,real_scale_y:1,real_rotate:0,real_skew_x:0,real_skew_y:0,real_opacity:1,real_propagation:!0})},refresh:function(){this._refresh(!0,!0),this._canvas._event_mouse=null},_refreshDOM:function(){var f={position:"absolute",opacity:this.opacity,width:this.width+"px",height:this.height+"px",display:this._visible?"block":"none"},e={transform:"rotate("+this.rotation+"deg) scale("+this.scaleX+", "+this.scaleY+") skew("+this.skewX+"deg, "+this.skewY+"deg) translate("+this.x+"px, "+this.y+"px)","transform-origin":this.regX+" "+this.regY};_CanvasEngine.each(["","-webkit-","-moz-","-o-"],function(g,h){for(s in e)f[h+s]=e[s]}),_CanvasEngine.extend(this._dom.style,f)},_refresh:function(l,g,e){if(this.stage._onRefresh&&this.stage._onRefresh(this),!this._visible)return void this._loop();if(!this.real_pause){this._initParams(l),this.real_propagation=null==this.parent.propagationOpacity?!0:this.parent.propagationOpacity,this.save(),this.real_scale_x=this.parent.real_scale_x*this.scaleX,this.real_scale_y=this.parent.real_scale_y*this.scaleY,this.real_y=this.parent.real_y+this.y,this.real_x=this.parent.real_x+this.x,this.real_skew_x=this.parent.real_skew_x+this.skewX,this.real_skew_y=this.parent.real_skew_y+this.skewY,this.real_rotate=this.parent.real_rotate+this.rotation,this.real_propagation?this.real_opacity=this.parent.real_opacity*this.opacity:this.real_opacity=this.opacity,this.real_pause=l?this.pause:this.parent.real_pause,this.globalAlpha=this.real_opacity,this.parent&&(this.parent.regX&&(this.regX=this.parent.regX),this.parent.regY&&(this.regY=this.parent.regY));var k=this.real_x+this.regX,h=this.real_y+this.regY;0==this.regX&&0==this.regY||this.translate(k,h),0!=this.real_rotate&&this.rotateDeg(this.real_rotate),1==this.real_scale_x&&1==this.real_scale_y&&0==this.real_skew_x&&0==this.real_skew_y||this.transform(this.real_scale_x,this.real_skew_x,this.real_skew_y,this.real_scale_y,0,0),0==this.regX&&0==this.regY||this.translate(-k,-h),this.translate(this.real_x,this.real_y)}if(this.draw(e),this._useClip||this.restore(),this._useDOM&&this._refreshDOM(),g){this.getScene()._pause||this._loop();for(var f=0;f<this._children.length;f++)this._children[f]._refresh(!1,!0,e)}this._useClip&&this.restore()},setX:function(e){this.x=e},setY:function(e){this.y=e},buffer:function(f,m){var l=this.children(),g=document.createElement("canvas"),e=g.getContext("2d"),n=(this.getScene(),this.scene.getCanvas());g.width=f||n.width,g.height=m||n.height,this.scene.getCanvas()._ctxTmp=e;for(var k=0;k<l.length;k++)this._children[k]._refresh(!0,!0);return this.scene.getCanvas()._ctxTmp=null,g},rotateTo:function(f,e){var g=parseInt(f);return/rad$/.test(f)&&(g=180*g/Math.PI),this.rotation=e?360-g:g,this._stageRefresh(),this},setOriginPoint:function(e,f){if("middle"==e){if(!this.width||!this.height)throw"Width and Height proprieties are not defined";e=Math.round(this.width/2),f=Math.round(this.height/2)}return void 0!==e&&(this.regX=+e),void 0!==f&&(this.regY=+f),this},getScene:function(){return this.scene},_stageRefresh:function(){this.stage.refresh()},isStage:function(){return"__stage__"==this._name},_mousemove:function(l,g){for(var f,k,h=0;h<this._children.length;h++)if(f=this._children[h],k=g.x>f.real_x&&g.x<f.real_x+f.width&&g.y>f.real_y&&g.y<f.real_y+f.height){if(1==f._out&&(f._out++,f._out++,f._over=1,_trigger=f.trigger("mouseover",l)),_trigger)return}else 1==f._over&&(f._out=1,f._over++,_trigger=f.trigger("mouseout",l))},_select:function(i,o){var h,e,f=this.scene.getCanvas(),l=this._canvas[0],n=l.element.style.width,g=l.element.style.height,m=""!=n?~~(i.x*l.width/parseInt(n)):i.x,k=""!=g?~~(i.y*l.height/parseInt(g)):i.y;e=l._ctxMouseEvent.getImageData(m,k,1,1).data,e[3]>0&&(h=f._elementsByScene(this.scene.name,_CanvasEngine.rgbToHex(e[0],e[1],e[2])),h&&o(h))},_click:function(h,f,g){this._select(f,function(e){e.trigger("click",h,f)})},_cloneRecursive:function(g){var k,h;if(g._children.length>0)for(var f=0;f<g._children.length;f++){k=g._children[f],h=this.scene.createElement();for(var e in k)"function"!=typeof e&&(h[e]=k[e]);h.parent=g,this._cloneRecursive(k),g._children[f]=h}},clone:function(){var f=this.scene.createElement();for(var e in this)"function"!=typeof e&&(f[e]=this[e]);return this._cloneRecursive(f),f},append:function(m){function k(i){i._useDOM&&i.parent&&(i.parent._dom.appendChild(i._dom),f.isStage()||(i.parent._useDOM=!0,k(i.parent)))}function e(i){i._useDOM=!0,k(i),i._refreshDOM()}var l,f=this;this.scene.getCanvas();if(m instanceof Element)return this._dom.appendChild(m),e(this),this;if("undefined"!=typeof jQuery&&m instanceof jQuery)return jQuery(this._dom).append(m),e(this),this;for(var h=0;h<arguments.length;h++)l=arguments[h],this._children.push(l),l.parent=this,l._refresh(!1,!0),k(l);return arguments},prepend:function(e){return this._children.push(e),e.parent=this,e.zIndex(0),e},insertAfter:function(f){var e=f.parent.children();return e.push(this),this},children:function(g){var h=[],e=[];if(g){g instanceof Array&&(h=g),g instanceof Class&&(h=g.children());for(var f=0;f<h.length;f++)e[f]=h[f].clone(),e[f].parent=this;this._children=e}return this._children},detach:function(){return this.remove(),this},pack:function(o,m,n){var e,f=this.children(),g=document.createElement("canvas"),p=g.getContext("2d"),l=this.getScene();g.width=o,g.height=m,this.scene.getCanvas()._ctxTmp=p;for(var k=0;k<f.length;k++)this._children[k]._refresh(!0,!0);return this.scene.getCanvas()._ctxTmp=null,n||(this._pack=f),this.empty(),e=l.createElement(),e.drawImage(g),this.append(e),this},cache:function(f,i,l){var g=document.createElement("canvas"),e=g.getContext("2d"),k=this.scene.getCanvas();return"boolean"==typeof f&&(l=f,f=null),g.width=f||this.width,g.height=i||this.height,k._ctxTmp=e,this._refresh(!0,!0),k._ctxTmp=null,l||(this._cache=this._cmd),this._cmd=[],this.drawImage(g),this},uncache:function(){if(!this._cache)throw"Use the method `cache` before or impossible because you release the memory with method `cache`";return this._cmd=[],this._refresh(!0,!0),this._cmd=this._cache,this._cache=null,this},unpack:function(){if(!this._pack)throw"Use the method pack before or impossible because you release the memory with method pack";return this._children=this._pack,this._pack=null,this},forceEvent:function(f){if(void 0==f&&(f=!0),this._forceEvent=f,!f)return this.removeCmd("rect"),this;var e=this.width,g=this.height;if(e||(e=this.img.width),g||(g=this.img.height),!e||!g)throw"forceEvent() : Before, indicate the size of element !";return this.beginPath(),this.rect(0,0,e,g),this.closePath(),this},isAppend:function(){return this in this.parent.children()},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(f){var g=this.children(),e=g.length;return Math.abs(f)>=e&&(f=-1),0>f&&(f=e+f),g[f]},next:function(e,l){var g=this.zIndex();if(e){for(var f,m,k=this.parent.children(),h=g+1;h<k.length;h++)if(m=k[h],f=this._findAttr(e,l,m))return m;return!1}return this.parent.eq(g+1)},prev:function(e,l){var g=this.zIndex();if(e){for(var f,m,k=this.parent.children(),h=g-1;h>=0;h--)if(m=k[h],f=this._findAttr(e,l,m))return m;return!1}return this.parent.eq(g-1)},find:function(e){for(var g=this.children(),h=[],f=0;f<g.length;f++)c=g[f],e==c.name&&h.push(c);return h},_findAttr:function(e,g,h){var f=h.attr(e);if(f){if(void 0==g)return h;if(f==g)return h}return!1},findAttr:function(e,l){for(var f,h=this.children(),k=[],g=0;g<h.length;g++)f=this._findAttr(e,l,h[g]),f&&k.push(f);return k},zIndex:function(f){var e;if(!this.parent)throw"zIndex: No parent known for this element. Assign a parent of this element with append()";return void 0===f?this.parent._children.indexOf(this):(f instanceof Class&&(f=f.zIndex()),e=this.parent._children.length,Math.abs(f)>=e&&(f=-1),0>f&&(f=e+f),_CanvasEngine.moveArray(this.parent._children,this.zIndex(),f),this._stageRefresh(),this)},zIndexBefore:function(e){return this.zIndex(e.zIndex()-1),this},remove:function(){for(var g,e=this.scene.getCanvas(),f=0;f<this.parent._children.length;f++)if(g=this.parent._children[f],this._id==g._id)return e._layerDOM&&g._useDOM&&e._layerDOM.removeChild(g._dom),this.parent._children.splice(f,1),this._stageRefresh(),!0;return!1},empty:function(){return this._children=[],this},attr:function(e,g,f){return f=void 0==f?!0:f,void 0===g?this._attr[e]:(this._attr[e]!=g&&f&&this.trigger("element:attrChange",[e,g]),this._attr[e]=g,this)},removeAttr:function(e){return this._attr[e]&&delete this._attr[e],this},offset:function(f){if(f){var e=this.parent;return f.left&&(this.x=f.left),f.right&&e&&(this.x=e.width-this.width),f.top&&(this.y=f.top),f.bottom&&e&&(this.y=e.height-this.height),this}return{left:this.x,top:this.y}},position:function(){return{left:this.real_x,top:this.real_y}},scaleTo:function(e){return this.scaleX=e,this.scaleY=e,this},hide:function(){this._visible=!1},show:function(){this._visible=!0},toggle:function(){this._visible?this.hide():this.show()},bind:function(e,f){this.on(e,f)},on:function(f,h){var g;f=f.split(" ");for(var e=0;e<f.length;e++)g=f[e],"canvas:refresh"==g?this.stage._onRefresh=h:"canvas:render"==g?this._onRender.push(h):b.mobileUserAgent&&"click"==g&&(g="touch"),this._listener[g]||(this._listener[g]=[],this._nbEvent++),this._listener[g].push(h)},unbind:function(e,f){this.off(e,f)},off:function(f,h){var g;f=f.split(" ");for(var e=0;e<f.length;e++){if(g=f[e],h){if("canvas:render"==g)for(var e=0;e<this._onRender.length;e++)if(this._onRender[e]==h){this._onRender.splice(e,1);break}for(var e=0;e<this._listener[g].length;e++)if(this._listener[g][e]==h){this._listener[g].splice(e,1);break}}else"canvas:render"==g&&(this._onRender=[]),this._listener[g]&&(delete this._listener[g],this._nbEvent--);this._listener[g]&&0==this._listener[g].length&&(delete this._listener[g],this._nbEvent--)}},eventExist:function(e){return this._listener[e]&&this._listener[e].length>0},hasEvent:function(){return this._nbEvent>0},trigger:function(k,m){var l,f=!1;k=k.split(" "),m instanceof Array||(m=[m]);for(var g=0;g<k.length;g++)if(l=k[g],this._listener[l])for(var h=0;h<this._listener[l].length;h++)f=!0,this._listener[l][h]&&this._listener[l][h].apply(this,m);return f},click:function(e){this.on("click",e)},dblclick:function(e){this.on("dblclick",e)},mouseover:function(e){this.on("mouseover",e)},mouseout:function(e){this.on("mouseout",e)},_loop:function(){for(var e=0;e<this._onRender.length;e++)this._onRender[e]&&this._onRender[e].call(this)},addLoopListener:function(e){this.on("canvas:render",e)},html:function(e){return this._useDOM=!0,this._dom.innerHTML=e,this},css:function(e){return this._useDOM=!0,_CanvasEngine.extend(this._dom.style,e),this}}).extend("Context"),Global_CE=b=Class["new"]("CanvasEngineClass"),b},CanvasEngine.Core=CanvasEngine,CanvasEngine.Class=Class;var CE=CanvasEngine;!function(F){function e(){if(!z.READY){z.event.determineEventTypes();for(var P in z.gestures)z.gestures.hasOwnProperty(P)&&z.detection.register(z.gestures[P]);z.event.onTouch(document,z.EVENT_MOVE,z.detection.detect),z.event.onTouch(document,z.EVENT_END,z.detection.endDetect),z.READY=!0}}var z=function(Q,P){return new z.Instance(Q,P||{})};z.defaults={stop_browser_behavior:{userSelect:"none",touchCallout:"none",touchAction:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}},z.HAS_POINTEREVENTS=navigator.pointerEnabled||navigator.msPointerEnabled,z.HAS_TOUCHEVENTS="ontouchstart"in F,z.EVENT_TYPES={},z.DIRECTION_DOWN="down",z.DIRECTION_LEFT="left",z.DIRECTION_UP="up",z.DIRECTION_RIGHT="right",z.POINTER_MOUSE="mouse",z.POINTER_TOUCH="touch",z.POINTER_PEN="pen",z.EVENT_START="start",z.EVENT_MOVE="move",z.EVENT_END="end",z.plugins={},z.READY=!1,z.Instance=function(R,Q){var P=this;return e(),this.element=R,this.enabled=!0,this.options=z.utils.extend(z.utils.extend({},z.defaults),Q||{}),this.options.stop_browser_behavior&&z.utils.stopDefaultBrowserBehavior(this.element,this.options.stop_browser_behavior),z.event.onTouch(R,z.EVENT_START,function(S){P.enabled&&z.detection.startDetect(P,S)}),this},z.Instance.prototype={on:function(Q,R){for(var S=Q.split(" "),P=0;P<S.length;P++)this.element.addEventListener(S[P],R,!1);return this},off:function(Q,R){for(var S=Q.split(" "),P=0;P<S.length;P++)this.element.removeEventListener(S[P],R,!1);return this},trigger:function(P,R){var Q=document.createEvent("Event");return Q.initEvent(P,!0,!0),Q.gesture=R,this.element.dispatchEvent(Q),this},enable:function(P){return this.enabled=P,this}};var J=null,l=!1,h=!1;z.event={bindDom:function(R,T,S){for(var Q=T.split(" "),P=0;P<Q.length;P++)R.addEventListener(Q[P],S,!1)},onTouch:function(R,Q,S){var P=this;this.bindDom(R,z.EVENT_TYPES[Q],function(T){var U=T.type.toLowerCase();return U.match(/mouseup/)&&h?void(h=!1):((U.match(/touch/)||U.match(/mouse/)&&1===T.which||z.HAS_POINTEREVENTS&&U.match(/down/))&&(l=!0),U.match(/touch|pointer/)&&(h=!0),!l||h&&U.match(/mouse/)||(z.HAS_POINTEREVENTS&&Q!=z.EVENT_END&&z.PointerEvent.updatePointer(Q,T),Q===z.EVENT_END&&null!==J?T=J:J=T,S.call(z.detection,P.collectEventData(R,Q,T)),z.HAS_POINTEREVENTS&&Q==z.EVENT_END&&z.PointerEvent.updatePointer(Q,T)),void(U.match(/up|cancel|end/)&&(l=!1,J=null,z.PointerEvent.reset())))})},determineEventTypes:function(){var P;P=z.HAS_POINTEREVENTS?z.PointerEvent.getEvents():["touchstart mousedown","touchmove mousemove","touchend touchcancel mouseup"],z.EVENT_TYPES[z.EVENT_START]=P[0],z.EVENT_TYPES[z.EVENT_MOVE]=P[1],z.EVENT_TYPES[z.EVENT_END]=P[2]},getTouchList:function(P){return z.HAS_POINTEREVENTS?z.PointerEvent.getTouchList():P.touches?P.touches:[{identifier:1,pageX:P.pageX,pageY:P.pageY,target:P.target}]},collectEventData:function(R,Q,S){var T=this.getTouchList(S,Q),P=z.POINTER_TOUCH;return(S.type.match(/mouse/)||z.PointerEvent.matchType(z.POINTER_MOUSE,S))&&(P=z.POINTER_MOUSE),{center:z.utils.getCenter(T),timestamp:S.timestamp||(new Date).getTime(),target:S.target,touches:T,eventType:Q,pointerType:P,srcEvent:S,preventDefault:function(){this.srcEvent.preventManipulation&&this.srcEvent.preventManipulation(),this.srcEvent.preventDefault&&this.srcEvent.preventDefault()},stopPropagation:function(){this.srcEvent.stopPropagation()},stopDetect:function(){return z.detection.stopDetect()}}}},z.PointerEvent={pointers:{},getTouchList:function(){var P=this.pointers,Q=[];return Object.keys(P).sort().forEach(function(R){Q.push(P[R])}),Q},updatePointer:function(Q,P){Q==z.EVENT_END?delete this.pointers[P.pointerId]:(P.identifier=P.pointerId,this.pointers[P.pointerId]=P)},matchType:function(P,R){if(!R.pointerType)return!1;var Q={};return Q[z.POINTER_MOUSE]=R.pointerType==R.MSPOINTER_TYPE_MOUSE||R.pointerType==z.POINTER_MOUSE,Q[z.POINTER_TOUCH]=R.pointerType==R.MSPOINTER_TYPE_TOUCH||R.pointerType==z.POINTER_TOUCH,Q[z.POINTER_PEN]=R.pointerType==R.MSPOINTER_TYPE_PEN||R.pointerType==z.POINTER_PEN,Q[P]},getEvents:function(){return["pointerdown MSPointerDown","pointermove MSPointerMove","pointerup pointercancel MSPointerUp MSPointerCancel"]},reset:function(){this.pointers={}}},z.utils={extend:function(P,R){for(var Q in R)P[Q]=R[Q];return P},getCenter:function(S){for(var T=[],R=[],Q=0,P=S.length;P>Q;Q++)T.push(S[Q].pageX),R.push(S[Q].pageY);return{pageX:(Math.min.apply(Math,T)+Math.max.apply(Math,T))/2,pageY:(Math.min.apply(Math,R)+Math.max.apply(Math,R))/2}},getVelocity:function(P,R,Q){return{x:Math.abs(R/P)||0,y:Math.abs(Q/P)||0}},getAngle:function(R,Q){var S=Q.pageY-R.pageY,P=Q.pageX-R.pageX;return 180*Math.atan2(S,P)/Math.PI},getDirection:function(R,Q){var P=Math.abs(R.pageX-Q.pageX),S=Math.abs(R.pageY-Q.pageY);return P>=S?R.pageX-Q.pageX>0?z.DIRECTION_LEFT:z.DIRECTION_RIGHT:R.pageY-Q.pageY>0?z.DIRECTION_UP:z.DIRECTION_DOWN},getDistance:function(R,Q){var P=Q.pageX-R.pageX,S=Q.pageY-R.pageY;return Math.sqrt(P*P+S*S)},getScale:function(Q,P){return Q.length>=2&&P.length>=2?this.getDistance(P[0],P[1])/this.getDistance(Q[0],Q[1]):1},getRotation:function(Q,P){return Q.length>=2&&P.length>=2?this.getAngle(P[1],P[0])-this.getAngle(Q[1],Q[0]):0},isVertical:function(P){return P==z.DIRECTION_UP||P==z.DIRECTION_DOWN},stopDefaultBrowserBehavior:function(R,Q){var U,T=["webkit","khtml","moz","ms","o",""];if(Q&&R.style){for(var P=0;P<T.length;P++)for(var S in Q)Q.hasOwnProperty(S)&&(U=S,T[P]&&(U=T[P]+U.substring(0,1).toUpperCase()+U.substring(1)),R.style[U]=Q[S]);"none"==Q.userSelect&&(R.onselectstart=function(){return!1})}}},z.detection={gestures:[],current:null,previous:null,stopped:!1,startDetect:function(Q,P){this.current||(this.stopped=!1,this.current={inst:Q,startEvent:z.utils.extend({},P),lastEvent:!1,name:""},this.detect(P))},detect:function(S){if(this.current&&!this.stopped){S=this.extendEventData(S);for(var T=this.current.inst.options,R=0,P=this.gestures.length;P>R;R++){var Q=this.gestures[R];if(!this.stopped&&T[Q.name]!==!1&&Q.handler.call(Q,S,this.current.inst)===!1){this.stopDetect();break}}this.current&&(this.current.lastEvent=S)}},endDetect:function(P){this.detect(P),this.stopDetect()},stopDetect:function(){this.previous=z.utils.extend({},this.current),this.current=null,this.stopped=!0},extendEventData:function(T){var U=this.current.startEvent;if(U&&(T.touches.length!=U.touches.length||T.touches===U.touches)){U.touches=[];for(var R=0,P=T.touches.length;P>R;R++)U.touches.push(z.utils.extend({},T.touches[R]))}var Q=T.timestamp-U.timestamp,W=T.center.pageX-U.center.pageX,V=T.center.pageY-U.center.pageY,S=z.utils.getVelocity(Q,W,V);return z.utils.extend(T,{deltaTime:Q,deltaX:W,deltaY:V,velocityX:S.x,velocityY:S.y,distance:z.utils.getDistance(U.center,T.center),angle:z.utils.getAngle(U.center,T.center),direction:z.utils.getDirection(U.center,T.center),scale:z.utils.getScale(U.touches,T.touches),rotation:z.utils.getRotation(U.touches,T.touches),startEvent:U}),T},register:function(Q){var P=Q.defaults||{};return"undefined"==typeof P[Q.name]&&(P[Q.name]=!0),z.utils.extend(z.defaults,P),Q.index=Q.index||1e3,this.gestures.push(Q),this.gestures.sort(function(S,R){return S.index<R.index?-1:S.index>R.index?1:0}),this.gestures}},z.gestures=z.gestures||{},z.gestures.Hold={name:"hold",index:10,defaults:{hold_timeout:500,hold_threshold:1},timer:null,handler:function(P,Q){switch(P.eventType){case z.EVENT_START:clearTimeout(this.timer),z.detection.current.name=this.name,this.timer=setTimeout(function(){"hold"==z.detection.current.name&&Q.trigger("hold",P)},Q.options.hold_timeout);break;case z.EVENT_MOVE:P.distance>Q.options.hold_threshold&&clearTimeout(this.timer);break;case z.EVENT_END:clearTimeout(this.timer)}}},z.gestures.Tap={name:"tap",index:100,defaults:{tap_max_touchtime:250,tap_max_distance:10,doubletap_distance:20,doubletap_interval:300},handler:function(Q,R){if(Q.eventType==z.EVENT_END){var P=z.detection.previous;if(Q.deltaTime>R.options.tap_max_touchtime||Q.distance>R.options.tap_max_distance)return;P&&"tap"==P.name&&Q.timestamp-P.lastEvent.timestamp<R.options.doubletap_interval&&Q.distance<R.options.doubletap_distance?z.detection.current.name="doubletap":z.detection.current.name="tap",R.trigger(z.detection.current.name,Q)}}},z.gestures.Swipe={name:"swipe",index:40,defaults:{swipe_max_touches:1,swipe_velocity:.7},handler:function(P,Q){if(P.eventType==z.EVENT_END){if(Q.options.swipe_max_touches>0&&P.touches.length>Q.options.swipe_max_touches)return;(P.velocityX>Q.options.swipe_velocity||P.velocityY>Q.options.swipe_velocity)&&(Q.trigger(this.name,P),Q.trigger(this.name+P.direction,P))}}},z.gestures.Drag={name:"drag",index:50,defaults:{drag_min_distance:10,drag_max_touches:1,drag_block_horizontal:!1,drag_block_vertical:!1,drag_lock_to_axis:!1},triggered:!1,handler:function(P,Q){if(z.detection.current.name!=this.name&&this.triggered)return Q.trigger(this.name+"end",P),void(this.triggered=!1);if(!(Q.options.drag_max_touches>0&&P.touches.length>Q.options.drag_max_touches))switch(P.eventType){case z.EVENT_START:this.triggered=!1;break;case z.EVENT_MOVE:if(P.distance<Q.options.drag_min_distance&&z.detection.current.name!=this.name)return;z.detection.current.name=this.name;var R=z.detection.current.lastEvent.direction;Q.options.drag_lock_to_axis&&R!==P.direction&&(z.utils.isVertical(R)?P.direction=P.deltaY<0?z.DIRECTION_UP:z.DIRECTION_DOWN:P.direction=P.deltaX<0?z.DIRECTION_LEFT:z.DIRECTION_RIGHT),this.triggered||(Q.trigger(this.name+"start",P),this.triggered=!0),Q.trigger(this.name,P),Q.trigger(this.name+P.direction,P),(Q.options.drag_block_vertical&&z.utils.isVertical(P.direction)||Q.options.drag_block_horizontal&&!z.utils.isVertical(P.direction))&&P.preventDefault();break;case z.EVENT_END:this.triggered&&Q.trigger(this.name+"end",P),this.triggered=!1}}},z.gestures.Transform={name:"transform",index:45,defaults:{transform_min_scale:.01,transform_min_rotation:1,transform_always_block:!1},triggered:!1,handler:function(R,S){if(z.detection.current.name!=this.name&&this.triggered)return S.trigger(this.name+"end",R),void(this.triggered=!1);if(!(R.touches.length<2))switch(S.options.transform_always_block&&R.preventDefault(),R.eventType){case z.EVENT_START:this.triggered=!1;break;case z.EVENT_MOVE:var Q=Math.abs(1-R.scale),P=Math.abs(R.rotation);if(Q<S.options.transform_min_scale&&P<S.options.transform_min_rotation)return;z.detection.current.name=this.name,this.triggered||(S.trigger(this.name+"start",R),this.triggered=!0),S.trigger(this.name,R),P>S.options.transform_min_rotation&&S.trigger("rotate",R),Q>S.options.transform_min_scale&&(S.trigger("pinch",R),S.trigger("pinch"+(R.scale<1?"in":"out"),R));break;case z.EVENT_END:this.triggered&&S.trigger(this.name+"end",R),this.triggered=!1}}},z.gestures.Touch={name:"touch",index:-(1/0),defaults:{prevent_default:!1},handler:function(P,Q){Q.options.prevent_default&&P.preventDefault(),P.eventType==z.EVENT_START&&Q.trigger(this.name,P)}},z.gestures.Release={name:"release",index:1/0,handler:function(P,Q){P.eventType==z.EVENT_END&&Q.trigger(this.name,P)}},"object"==typeof module&&"object"==typeof module.exports?module.exports=z:(F.Hammer=z,"function"==typeof F.define&&F.define.amd&&F.define("hammer",[],function(){return z}))}(this);var Ease={linear:function(e,f,a,h,g){return h*(f/=g)+a},easeInQuad:function(e,f,a,h,g){return h*(f/=g)*f+a},easeOutQuad:function(e,f,a,h,g){return-h*(f/=g)*(f-2)+a},easeInOutQuad:function(e,f,a,h,g){return(f/=g/2)<1?h/2*f*f+a:-h/2*(--f*(f-2)-1)+a},easeInCubic:function(e,f,a,h,g){return h*(f/=g)*f*f+a},easeOutCubic:function(e,f,a,h,g){return h*((f=f/g-1)*f*f+1)+a},easeInOutCubic:function(e,f,a,h,g){return(f/=g/2)<1?h/2*f*f*f+a:h/2*((f-=2)*f*f+2)+a},easeInQuart:function(e,f,a,h,g){return h*(f/=g)*f*f*f+a},easeOutQuart:function(e,f,a,h,g){return-h*((f=f/g-1)*f*f*f-1)+a},easeInOutQuart:function(e,f,a,h,g){return(f/=g/2)<1?h/2*f*f*f*f+a:-h/2*((f-=2)*f*f*f-2)+a},easeInQuint:function(e,f,a,h,g){return h*(f/=g)*f*f*f*f+a},easeOutQuint:function(e,f,a,h,g){return h*((f=f/g-1)*f*f*f*f+1)+a},easeInOutQuint:function(e,f,a,h,g){return(f/=g/2)<1?h/2*f*f*f*f*f+a:h/2*((f-=2)*f*f*f*f+2)+a},easeInSine:function(e,f,a,h,g){return-h*Math.cos(f/g*(Math.PI/2))+h+a},easeOutSine:function(e,f,a,h,g){return h*Math.sin(f/g*(Math.PI/2))+a},easeInOutSine:function(e,f,a,h,g){return-h/2*(Math.cos(Math.PI*f/g)-1)+a},easeInExpo:function(e,f,a,h,g){return 0==f?a:h*Math.pow(2,10*(f/g-1))+a},easeOutExpo:function(e,f,a,h,g){return f==g?a+h:h*(-Math.pow(2,-10*f/g)+1)+a},easeInOutExpo:function(e,f,a,h,g){return 0==f?a:f==g?a+h:(f/=g/2)<1?h/2*Math.pow(2,10*(f-1))+a:h/2*(-Math.pow(2,-10*--f)+2)+a},easeInCirc:function(e,f,a,h,g){return-h*(Math.sqrt(1-(f/=g)*f)-1)+a},easeOutCirc:function(e,f,a,h,g){return h*Math.sqrt(1-(f=f/g-1)*f)+a},easeInOutCirc:function(e,f,a,h,g){return(f/=g/2)<1?-h/2*(Math.sqrt(1-f*f)-1)+a:h/2*(Math.sqrt(1-(f-=2)*f)+1)+a},easeInElastic:function(f,h,e,m,l){var i=1.70158,k=0,g=m;if(0==h)return e;if(1==(h/=l))return e+m;if(k||(k=.3*l),g<Math.abs(m)){g=m;var i=k/4}else var i=k/(2*Math.PI)*Math.asin(m/g);return-(g*Math.pow(2,10*(h-=1))*Math.sin((h*l-i)*(2*Math.PI)/k))+e},easeOutElastic:function(f,h,e,m,l){var i=1.70158,k=0,g=m;if(0==h)return e;if(1==(h/=l))return e+m;if(k||(k=.3*l),g<Math.abs(m)){g=m;var i=k/4}else var i=k/(2*Math.PI)*Math.asin(m/g);return g*Math.pow(2,-10*h)*Math.sin((h*l-i)*(2*Math.PI)/k)+m+e},easeInOutElastic:function(f,h,e,m,l){var i=1.70158,k=0,g=m;if(0==h)return e;if(2==(h/=l/2))return e+m;if(k||(k=l*(.3*1.5)),g<Math.abs(m)){g=m;var i=k/4}else var i=k/(2*Math.PI)*Math.asin(m/g);return 1>h?-.5*(g*Math.pow(2,10*(h-=1))*Math.sin((h*l-i)*(2*Math.PI)/k))+e:g*Math.pow(2,-10*(h-=1))*Math.sin((h*l-i)*(2*Math.PI)/k)*.5+m+e},easeInBack:function(e,f,a,i,h,g){return void 0==g&&(g=1.70158),i*(f/=h)*f*((g+1)*f-g)+a},easeOutBack:function(e,f,a,i,h,g){return void 0==g&&(g=1.70158),i*((f=f/h-1)*f*((g+1)*f+g)+1)+a},easeInOutBack:function(e,f,a,i,h,g){return void 0==g&&(g=1.70158),(f/=h/2)<1?i/2*(f*f*(((g*=1.525)+1)*f-g))+a:i/2*((f-=2)*f*(((g*=1.525)+1)*f+g)+2)+a},easeInBounce:function(e,f,a,h,g){return h-jQuery.easing.easeOutBounce(e,g-f,0,h,g)+a},easeOutBounce:function(e,f,a,h,g){return(f/=g)<1/2.75?h*(7.5625*f*f)+a:2/2.75>f?h*(7.5625*(f-=1.5/2.75)*f+.75)+a:2.5/2.75>f?h*(7.5625*(f-=2.25/2.75)*f+.9375)+a:h*(7.5625*(f-=2.625/2.75)*f+.984375)+a},easeInOutBounce:function(e,f,a,h,g){return g/2>f?.5*jQuery.easing.easeInBounce(e,2*f,0,h,g)+a:.5*jQuery.easing.easeOutBounce(e,2*f-g,0,h,g)+.5*h+a}};Class.create("Timeline",{_timeline:{},_frequence:0,_stop:!1,_propreties:[],_key_times:[],_onFinish:null,_varTime:{},initialize:function(a){this._frequence=0,this.el=a,this.addProprety(["opacity","x","y","scaleX","scaleY","rotation"]),this._loop()},to:function(a,e,d,b){
return d&&(a._ease_=d),b||(b="set"),this._key_times.push(e),this._timeline[e]=a,this._timeline[e]._cal=b,this},wait:function(b){var a=this.getLastKey();return this.to(a,b,!1,"wait"),this},getLastKey:function(){var b=this._key_times[this._key_times.length-1];if(!b){for(var d={},a=0;a<this._propreties.length;a++)d[this._propreties[a]]=this.el[this._propreties[a]];return d}return this._timeline[b]},add:function(a,d,b){return this.to(a,d,b,"add")},addProprety:function(a){a instanceof Array||(a=[a]);for(var b=0;b<a.length;b++)this._propreties.push(a[b])},loop:function(){var a=this;this.call(function(){return a._stop=!1,!0})},_initVar:function(){this._varTime={freq:this._frequence,time:0,time_tmp:0,last_t:0,next_t:0,find_next:!1}},_loop:function(){var b,a=this;this.el.addLoopListener(function(){function k(){for(var t={},r=0;r<a._propreties.length;r++)t[a._propreties[r]]=+this[a._propreties[r]];a._timeline[0]=t}function l(i){var t,r;if(void 0===a._timeline[m][i])return this[i];switch(t=a._timeline[m]._cal,r=a._timeline[m][i],t){case"add":r+=a._timeline[n][i]}return r}function d(i){var w,t,v,u;if(void 0===a._timeline[m][i])return this[i];switch(w=a._timeline[m]._ease_,v=a._timeline[m]._cal,u=a._timeline[m][i],v){case"add":u+=a._timeline[n][i]}return w||(w=Ease.linear),t=w(u,m-n-h,a._timeline[n][i],u-a._timeline[n][i],m-n)}if(void 0!==a._varTime.time){var e=a._varTime._frequence,f=a._varTime.time,h=a._varTime.time_tmp,n=a._varTime.last_t,m=a._varTime.next_t,p=a._varTime.find_next;e=0;if(!a._stop){if(e++,e>=a._frequence){if(0==f&&k.call(this),0==h){p=!1;for(var o in a._timeline)if(o>f){n=m?m:0,m=o,p=!0;break}if(!p){if(a._stop=!0,f=0,n=0,h=0,a._onFinish&&(b=a._onFinish.call(this)),!b)return;k.call(this),m=0}}if(h=m-f,0!=h&&"wait"!=a._timeline[m]._cal)if(1==h)for(var g=0;g<a._propreties.length;g++)this[a._propreties[g]]=l.call(this,a._propreties[g]);else for(var g=0;g<a._propreties.length;g++)this[a._propreties[g]]=d.call(this,a._propreties[g]);f++}a._varTime._frequence=e,a._varTime.time=f,a._varTime.time_tmp=h,a._varTime.last_t=n,a._varTime.next_t=m,a._varTime.find_next=p}}})},call:function(a){this._initVar(),this._onFinish=a,this._stop=!1}}),Class.create("Animation",{_images:[],_frames:{},_animations:{},_frequence:0,_stop:!1,_timeline:null,_onFinish:null,_seq:null,_loop:!1,_els:null,el:null,initialize:function(a){this._options=a,this._images=a.images,this._animations=a.animations,this._timeline=a.timeline,a.addIn&&(this.el=a.addIn.scene.createElement(),a.addIn.append(this.el),this.add())},remove:function(a){return a&&(this.el=a),this.el.off("canvas:render"),this},add:function(e,h){e&&(this.el=e);var b,a=this,d=0,g=null,f=0;h&&this.remove(),this.stop(),this.el.addLoopListener(function(){function v(z){if(y.size)return y.size;var A=Global_CE.Materials.get(z);y.size={width:A.width,height:A.height}}function i(D,C){var A=a._images;y.patternSize&&(y.size={width:n.width/y.patternSize.width,height:n.height/y.patternSize.height}),r=parseInt(C/Math.round(n.width/y.size.width)),u=C%Math.round(n.width/y.size.width);var z=y.size.width*u,B=y.size.height*r;D.trigger("animation:draw",C),y.image&&(A=y.image),y.position||(y.position={}),y.position.left||(y.position.left=0),y.position.top||(y.position.top=0),D.drawImage(A,z,B,y.size.width,y.size.height,y.position.left,y.position.top,y.size.width,y.size.height)}function t(){return"stop"==a._loop?(y.finish&&y.finish.call(a),a.stop(),!0):"remove"==a._loop?(a._options.addIn?this.empty():this.remove(),y.finish&&y.finish.call(a),a.stop(),!0):!1}a._seq!==b&&(b=a._seq,d=0,g=null);var y=a._animations[a._seq],p="loop"==a._loop;if(y&&!y.frequence&&(y.frequence=0),null==g&&y&&(g=y.frequence),a._stop)return y&&(g=y.frequence),void(d=0);if(g++,g>=y.frequence){if(a._images instanceof Array){var n=a._images[f];v(n),this.drawImage(n),f++,f>=a._images.length&&(f=0,p||(a._stop=!0))}else{var n=Global_CE.Materials.get(a._images),u=0,r=0;v(a._images);var w,k,l;n.width/y.size.width,n.height/y.size.height;if(y.frames[0]instanceof Array){if(void 0===y.frames[d]&&(d=0,t.call(this)))return;if(this.empty(),y.framesDefault=y.framesDefault||{},y.framesDefault.x||(y.framesDefault.x=0),y.framesDefault.y||(y.framesDefault.y=0),y.framesDefault.zoom||(y.framesDefault.zoom=100),y.framesDefault.opacity||(y.framesDefault.opacity=255),y.framesDefault.rotation||(y.framesDefault.rotation=0),!y.frames[d])return void d++;for(var m=0;m<y.frames[d].length;m++)w=y.frames[d][m],w&&(l=this.scene.createElement(y.size.width,y.size.height),k=w.pattern-1,l.setOriginPoint("middle"),l.x=void 0!=w.x?w.x:y.framesDefault.x,l.y=void 0!=w.y?w.y:y.framesDefault.y,l.scaleX=void 0!=w.zoom?w.zoom/100:y.framesDefault.zoom/100,l.scaleY=void 0!=w.zoom?w.zoom/100:y.framesDefault.zoom/100,l.opacity=void 0!=w.opacity?w.opacity/255:y.framesDefault.opacity/255,l.rotation=void 0!=w.rotation?w.rotation:y.framesDefault.rotation,i(l,k),this.append(l))}else k=y.frames[0]+d,k>y.frames[1]?(d=0,t.call(this),i(this,y.frames[0])):i(this,k);d++}g=0}})},isStopped:function(){return this._stop},stop:function(){return this._stop=!0,this},play:function(a,b){return this._loop=b,this._seq=a,this._stop=!1,this}});var Animation={Timeline:{New:function(){return this["new"].apply(this,arguments)},"new":function(a){return Class["new"]("Timeline",[a])}},Animation:{New:function(){return this["new"].apply(this,arguments)},"new":function(a){return Class["new"]("Animation",[a])}}},Input={Input:{keyBuffer:[],cacheKeyBuffer:[],_keyFunctions:{},_keyPress:{},_keyUp:{},_keyType:{},_keyPressed:{},_lock:{},_rules:{},_key:function(d,b,f){if("function"==typeof b)b(d);else if(b instanceof Array)for(var a=0;a<b.length;a++)d.which==b[a]&&f&&f(d);else d.which==b&&f&&f(d)},press:function(b,a){this._press("keyPress",b,a),this.keyUp(b)},clearKeys:function(a){this.press(a,function(){})},keyDown:function(b,a){this._press("keyDown",b,a)},keyUp:function(e,b){var a=this;if(e instanceof Array)for(var d=0;d<e.length;d++)a._keyUp[e[d]]=b;else a._keyUp[e]=b;document.onkeyup=function(f){a._keyPress[f.which]=0,a._keyPressed[f.which]=!1,a._keyUp[f.which]&&a._keyUp[f.which](f)}},_press:function(h,g,d){function k(l){var i;return a._keyPress[l.which]||(a._keyPress[l.which]=0),a._keyPress[l.which]++,a._keyPress[l.which]>1&&"keyPress"==a._keyType[l.which]?void 0:(a._keyPressed[l.which]=!0,a._keyFunctions[l.which]&&(i=a._keyFunctions[l.which](l)),void 0!==i?i:!1)}function e(l,i){a._keyType[l]=i,a._keyFunctions[l]=d}var a=this;if("string"==typeof g&&(g=this._rules[g]),g instanceof Array)for(var f=0;f<g.length;f++)e(g[f],h);else e(g,h);if(this._lock.canvas){var b=this._lock.canvas;b.onkeydown=k,b.onfocus=function(i){document.onkeydown=function(){return!1},a._lock.onFocus&&a._lock.onFocus(i,b)},b.onblur=function(i){document.onkeydown=null,a._lock.onBlur&&a._lock.onBlur(i,b)}}else document.onkeydown=k},reset:function(b){if(this._keyPressed={},b)for(var a=0;a<b.length;a++)this._keyFunctions[b[a]]=null;else this._keyFunctions={}},lock:function(a,f,b,d){var e=document.getElementById(a);e.setAttribute("tabindex",1),f&&(e.focus(),document.onkeydown=function(){return!1}),this._lock.canvas=e,this._lock.onFocus=b,this._lock.onBlur=d},isPressed:function(b){b instanceof Array||(b=[b]);for(var a=0;a<b.length;a++)if(this._keyPressed[b[a]])return!0;return!1},addKey:function(b,a){Input[b]=a},memorize:function(){this.cacheKeyBuffer=this.keyBuffer},restore:function(){this.keyBuffer=this.cacheKeyBuffer},trigger:function(d,e,a){var f,b,g;return"press"==e?(this.trigger(d,"down"),void this.trigger(d,"up",a)):(b=this._lock.canvas?this._lock.canvas:document,document.createEventObject?(f=document.createEventObject(),f.keyCode=d,b.fireEvent("onkey"+e,f)):document.createEvent&&(f=document.createEvent("Events"),f.initEvent("key"+e,!0,!0),f.which=d,b.dispatchEvent(f)),void(a&&(g=document.getElementById(a.id+"-dom"),g.focus())))},addRule:function(b,a){this._rules[b]=a},Gamepad:{_listener:{},gamepad:null,_onConnect:null,_onDisconnect:null,_connectState:!1,init:function(a,b){return this._onConnect=a,this._onDisconnect=b,this},getState:function(a){this.gamepad=Gamepad.getStates()[a],this.gamepad&&!this._connectState?(this._onConnect&&this._onConnect(),this._connectState=!0):!this.gamepad&&this._connectState&&(this._onDisconnect&&this._onDisconnect(),this._connectState=!1)},addListener:function(e,d,f){var a=Input.Input;if("function"!=typeof d){var b=d;d=function(){a.trigger(b,"down")},f=function(){a.trigger(b,"up")}}this._listener[e]={onDown:d,onUp:f,state:!1}},update:function(){if(this.getState(0),this.gamepad)for(var a in this._listener)1!=this.gamepad[a]||this._listener[a].state?0==this.gamepad[a]&&this._listener[a].state&&(this._listener[a].onUp&&this._listener[a].onUp(),this._listener[a].state=!1):(this._listener[a].onDown&&this._listener[a].onDown(),this._listener[a].state=!0)}},accelerometer:function(b){function a(d,f,e){b(d,f,e)}window.DeviceOrientationEvent?window.addEventListener("deviceorientation",function(d){a(d.alpha,d.beta,d.gamma)},!1):window.OrientationEvent&&window.addEventListener("MozOrientation",function(d){a(d.x,d.y,d.z)},!1)}}};Input.A=65,Input.Z=90,Input.E=69,Input.Q=81,Input.Esc=27,Input.Enter=13,Input.Shift=16,Input.Ctrl=17,Input.Alt=18,Input.Space=32,Input.Back=8,Input.F1=112,Input.F2=113,Input.F11=122,Input.F12=123,Input.Left=37,Input.Up=38,Input.Right=39,Input.Bottom=40;var BISON;if(function(n,f){function b(B,A){if("number"==typeof B){var z=B!==(0|B),u=0;if(0>B&&(B=-B,u=1),q(1+z,3),z){for(var r=1,t=10;B>=t;)r++,t*=10;for(r=8-r+1,B=Math.round(B*(1e9/t));B/10===(B/10|0);)B/=10,r--}2>B?q(B,4):16>B?(q(1,3),q(B,4)):256>B?(q(2,3),q(B,8)):4096>B?(q(3,3),q(B>>8&255,4),q(255&B,8)):65536>B?(q(4,3),q(B>>8&255,8),q(255&B,8)):1048576>B?(q(5,3),q(B>>16&255,4),q(B>>8&255,8),q(255&B,8)):16777216>B?(q(6,3),q(B>>16&255,8),q(B>>8&255,8),q(255&B,8)):(q(7,3),q(B>>24&255,8),q(B>>16&255,8),q(B>>8&255,8),q(255&B,8)),q(u,1),z&&q(r,4)}else if("string"==typeof B){var v=B.length;q(3,3),v>65535?(q(31,5),q(v>>24&255,8),q(v>>16&255,8),q(v>>8&255,8),q(255&v,8)):v>255?(q(30,5),q(v>>8&255,8),q(255&v,8)):v>28?(q(29,5),q(v,8)):q(v,5),g(B)}else if("boolean"==typeof B)q(+B,5);else if(null===B)q(2,5);else if(B instanceof n){q(4,3);for(var w=0,v=B.length;v>w;w++)b(B[w]);A||q(6,3)}else{q(5,3);for(var y in B)b(y),b(B[y]);A||q(6,3)}}function m(i){return l(),b(i,!0),q(0,3),q(3,2),p()}function a(w){var y,z,B,D,r,C,A=[],u=-1,v=!1;for(l(w);;){if(y=d(3),0===y){if(B=d(2),2===B)B=null;else if(2>B)B=!!B;else if(3===B)break}else if(1===y||2===y){switch(d(3)){case 0:B=d(1);break;case 1:B=d(4);break;case 2:B=d(8);break;case 3:B=(d(4)<<8)+d(8);break;case 4:B=(d(8)<<8)+d(8);break;case 5:B=(d(4)<<16)+(d(8)<<8)+d(8);break;case 6:B=(d(8)<<16)+(d(8)<<8)+d(8);break;case 7:B=(d(8)<<24)+(d(8)<<16)+(d(8)<<8)+d(8)}d(1)&&(B=-B),2===y&&(B/=h[d(4)])}else if(3===y){var E=d(5);switch(E){case 31:E=(d(8)<<24)+(d(8)<<16)+(d(8)<<8)+d(8);break;case 30:E=(d(8)<<8)+d(8);break;case 29:E=d(8)}if(B=e(E),v){D=B,v=!1;continue}}else{if(4===y||5===y){v=5===y,B=v?{}:[],C===f?C=B:r?z[D]=B:z.push(B),z=A[++u]=B,r=!(z instanceof Array);continue}if(6===y){z=A[--u],v=r=!(z instanceof Array);continue}}if(r)z[D]=B,v=!0;else{if(z===f)return B;z.push(B)}}return C}for(var o=function(){for(var u=new n(255),w=0;256>w;w++)u[w]=String.fromCharCode(w);for(var y=new n(8),v=new n(8),w=0;9>w;w++)y[w]=~(255^(v[w]=Math.pow(2,w)-1));var C="",B=0,t=8,z=0,A=0;return{open:function(i){t=8,i!==f?(A=i.length,z=0,C=i,B=C.charCodeAt(z)):(B=0,C="")},close:function(){return B>0&&(C+=u[B]),C},writeRaw:function(i){8!==t&&(C+=u[B],B=0,t=8),C+=i},readRaw:function(i){8!==t&&(z++,B=0,t=8);var E=C.substr(z,i);return z+=i,B=C.charCodeAt(z),E},write:function D(G,F){var H=F-t,E=F>t?t:F,i=t-E;B+=H>0?G>>H<<i:G<<i,t-=E,0===t&&(C+=u[B],t=8,B=0,H>0&&D(G&v[H],H))},read:function r(F){if(z>=A)return null;var H=F-t,E=F>t?t:F,i=t-E,G=(B&y[t])>>i;return t-=E,0===t&&(B=C.charCodeAt(++z),t=8,H>0&&(G=G<<H|r(H))),G}}}(),q=o.write,d=o.read,g=o.writeRaw,e=o.readRaw,l=o.open,p=o.close,h=new n(16),k=0;16>k;k++)h[k]=Math.pow(10,k);"undefined"==typeof window?(exports.encode=m,exports.decode=a,BISON=exports):window.BISON={encode:m,decode:a}}(Array),"undefined"!=typeof exports)var CE=require("canvasengine").listen(),Class=CE.Class;Class.create("Marshal",{_pointer:{},_cache:{},_stack_dump:[],_decode:function(b){if("undefined"==typeof navigator||"Microsoft Internet Explorer"!=navigator.appName)return BISON.decode(b);try{return JSON.parse(b)}catch(a){}},_encode:function(b){if("undefined"==typeof navigator||"Microsoft Internet Explorer"!=navigator.appName)return BISON.encode(b);try{return JSON.stringify(b)}catch(a){}},exist:function(a){return"undefined"!=typeof localStorage&&localStorage[a]},_recursiveData:function(f,l,h){var b,g={},d={};if(h=h||[],f instanceof Object){for(var a in f)if(b=f[a],"function"!=typeof b&&-1==(CE.Core||CE).inArray(a,h))if(b instanceof Array){d[a]=[];for(var e=0;e<b.length;e++)d[a][e]=this._recursiveData(b[e],l,h)}else b instanceof Object?d[a]=this._recursiveData(b,l,h):void 0!==b&&(d[a]=b)}else if("function"!=typeof f&&void 0!==f)return f;if("load"==l)if(d.__name__){g=Class.New(f.__name__,!1);for(var a in d)"function"!=typeof g[a]&&(g[a]=d[a])}else g=d;else g=d;return g},load:function(b,e){var f,a;return void 0===this._pointer[b]&&(this._pointer[b]=0),this._cache[b]?f=this._cache[b]:e?(f=this._decode(e)||[],this._cache[b]=f):"undefined"!=typeof localStorage&&(f=this._decode(localStorage[b])||[],this._cache[b]=f),a=this._recursiveData(f[this._pointer[b]],"load"),e||this.exist(b)?(this._pointer[b]++,a):!1},dump:function(b,d,f){var a={};a="number"==typeof b||"string"==typeof b||b instanceof Array?b:this._recursiveData(b,"save",f),this._stack_dump.push(a),"undefined"!=typeof localStorage&&(localStorage[d]=this._encode(this._stack_dump))},getStack:function(a){return a?this._encode(this._stack_dump):this._stack_dump},remove:function(a){return"undefined"!=typeof localStorage?(localStorage.removeItem(a),!0):!1}});var Marshal=Class.New("Marshal");Class.create("Scrolling",{main_el:null,scroll_el:[],scene:null,freeze:!1,initialize:function(d,b,a){this.scene=d,this.tile_h=b,this.tile_w=a},setMainElement:function(a){this.main_el=a},addScroll:function(a){return a.screen_x||(a.screen_x=0),a.screen_y||(a.screen_y=0),a.parallax_x||(a.parallax_x=0),a.parallax_y||(a.parallax_y=0),this.scroll_el.push(a),this.main_el&&this.setScreen(a),this.scroll_el[this.scroll_el.length-1]},setScreen:function(h,b,a){var d,i;!b&&this.main_el&&(b=this.main_el.x,a=this.main_el.y);var e=this.scene.getCanvas();d=b<=e.width/2?0:b+e.width/2>=h.width?-(h.width-e.width):-(b-e.width/2+e.width/2%this.tile_w),i=a<=e.height/2?0:a+e.height/2>=h.height?-(h.height-e.height):-(a-e.height/2+e.height/2%this.tile_h),h.element.x=d,h.element.y=i;var k=this.tile_w/h.speed,g=this.tile_h/h.speed;h.element.x=Math.floor(h.element.x/k)*k,h.element.y=Math.floor(h.element.y/g)*g,h.screen_x=Math.abs(h.element.x),h.screen_y=Math.abs(h.element.y);var f=this._multipleScreen(h.speed,h.screen_x,h.screen_y);h.screen_x=f.x,h.screen_y=f.y,this.update()},_multipleScreen:function(d,a,f){var e=this.tile_w/d,b=this.tile_h/d;return a=Math.floor(a/e)*e,f=Math.floor(f/b)*b,{x:a,y:f}},update:function(){var b,e,f=this.scene.getCanvas();if(!this.freeze&&this.main_el)for(var g=0;g<this.scroll_el.length;g++){b=this.scroll_el[g],e={x:b.element.x,y:b.element.y},b.screen_x=this.main_el.x-f.width/2+f.width/2%this.tile_w,b.screen_y=this.main_el.y-f.height/2+f.height/2%this.tile_h;var k=Math.abs(e.x),h=Math.abs(e.y),d=b.speed,a=b.speed;b.parallax?(b.screen_x!=b.parallax_x&&(b.screen_x>b.parallax_x?e.x-=d:e.x+=d,b.parallax_x=b.screen_x),b.screen_y!=b.parallax_y&&(b.screen_y>b.parallax_y?e.y-=a:e.y+=a,b.parallax_y=b.screen_y)):(k!=b.screen_x&&(b.screen_x>k?k>b.screen_x-d?e.x=-b.screen_x:e.x-=d:b.screen_x<k&&(k<b.screen_x+d?e.x=-b.screen_x:e.x+=d)),h!=b.screen_y&&(b.screen_y>h?h>b.screen_y-a?e.y=-b.screen_y:e.y-=a:b.screen_y<h&&(h<b.screen_y+a?e.y=-b.screen_y:e.y+=a))),b.block&&(e.x>0?b.screen_x=e.x=0:e.x+b.width<f.width&&(e.x=f.width-b.width,e.x=this._multipleScreen(b.speed,e.x,0).x,b.screen_x=Math.abs(e.x)),e.y>0?b.screen_y=e.y=0:e.y+b.height<f.height&&(e.y=f.height-b.height,e.y=this._multipleScreen(b.speed,0,e.y).y,b.screen_y=Math.abs(e.y))),f.width<=b.width&&(b.element.x=e.x>>0),f.height<=b.height&&(b.element.y=e.y>>0)}},mouseScroll:function(f,e,d){if(d=d||{},e.height<f.height)return f.append(e),this;var a={};return e._forceEvent=!0,f.beginPath(),f.rect(0,0,f.width,f.height),f.clip(),f.closePath(),e.rect(0,0,e.width,e.height),e.on("dragstart",function(g){a=this.offset(),a.time=(new Date).getTime(),d.dragstart&&d.dragstart.call(this,g)}),e.on("drag",function(g){"up"!=g.direction&&"left"!=g.direction||(g.distance=-g.distance);var h,i=1;h=a.top+g.distance*i,h>=0?(h=0,d.onTop&&d.onTop.call(this,g)):f.height>=h+this.height&&(h=-this.height+f.height,d.onBottom&&d.onBottom.call(this,g)),this.y=h,d.drag&&d.drag.call(this,g)}),e.on("dragend",function(g){d.dragend&&d.dragend.call(this,g)}),f.append(e),this}});var Scrolling={Scrolling:{New:function(){return this["new"].apply(this,arguments)},"new":function(d,b,a){return Class["new"]("Scrolling",[d,b,a])}}};Class.create("Spritesheet",{image:null,_set:{},initialize:function(a,b){this.image=a,b&&this.set(b)},set:function(n){var k,a,m,l,h,g,f=Global_CE.Materials.get(this.image,"image");if(!f)return!1;for(var b in n)if("grid"==b)for(var e=0;e<n.grid.length;e++)for(var d=0;d<n.grid[e].set.length;d++)a=n.grid[e].set[d],k=n.grid[e],k.tile||(k.tile=[f.width/k.size[0],f.height/k.size[1]]),l=k.tile[1]*parseInt(d/Math.round(k.size[0])),m=k.tile[0]*(d%Math.round(k.size[0])),k.reg||(k.reg=[0,0]),h=k.reg[0]||0,g=k.reg[1]||0,this._set[a]=[m,l,k.tile[0],k.tile[1],0,h,g];else this._set[b]=n[b]},exist:function(a){return!!this._set[a]},draw:function(e,i,b){b=b||{};var f=this._set[i];if(!f)throw"Spritesheet "+i+" don't exist";var h=+(b.x||"0")-f[5],g=+(b.y||"0")-f[6],a=b.w||f[2],d=b.h||f[3];e.drawImage(this.image,f[0],f[1],f[2],f[3],h,g,a,d)},pattern:function(d,f,a){if(!this._set[f])throw"Spritesheet "+f+" don't exist";var e=this._set[f],b=Global_CE.Materials.cropImage(this.image,e[0],e[1],e[2],e[3]);pattern=d.getScene().getCanvas().createPattern(b,a),d.fillStyle=pattern}});var Spritesheet={Spritesheet:{New:function(){return this["new"].apply(this,arguments)},"new":function(a,b){return Class["new"]("Spritesheet",[a,b])}}};Class.create("Window",{border:null,width:0,height:0,bitmap:null,el:null,_content:null,_borders:{},_border_size:{width:0,height:0},initialize:function(e,d,a,b){this.width=d,this.height=a,this.border=b,this.scene=e,b?(this.border_img=Global_CE.Materials.get(b),this._construct()):(this.el=this.scene.createElement(this.width,this.height),this._content=this.scene.createElement(),this.el.append(this._content))},_construct:function(){if(!Global_CE.Spritesheet)throw"Add Spritesheet class to use windows";var e,a,f=["corner_upleft","up","corner_upright","left","center","right","corner_bottomleft","bottom","corner_bottomright"];this.el=this.scene.createElement(this.width,this.height),this._border_size.width=this.border_img.width/3,this._border_size.height=this.border_img.height/3,this.spritesheet=Global_CE.Spritesheet["new"](this.border,{grid:[{size:[3,3],tile:[this._border_size.width,this._border_size.height],set:f}]}),this._content=this.scene.createElement();for(var d=0;d<f.length;d++)a=f[d],e=this._borders[a]=this.scene.createElement(),/^corner/.test(a)?this.spritesheet.draw(e,a):this.spritesheet.pattern(e,a),this.el.append(e);this._borders.center.zIndex(0),this.el.append(this._content),this.size(this.width,this.height)},size:function(e,a){function b(g){return 0>g?0:g}var f=this._border_size.width,d=this._border_size.height;return this._borders.up.x=f-1,this._borders.up.fillRect(0,0,e+1-2*f,d),this._borders.corner_upright.x=e-f,this._borders.left.y=d,this._borders.left.fillRect(0,0,f,b(a-2*d)),this._borders.right.x=e-f,this._borders.right.y=d,this._borders.right.fillRect(0,0,f,b(a-2*d)),this._borders.corner_bottomleft.y=a-d,this._borders.bottom.x=f-1,this._borders.bottom.y=a-d,this._borders.bottom.fillRect(0,0,b(e+1-2*f),d),this._borders.corner_bottomright.x=e-f,this._borders.corner_bottomright.y=a-d,this._borders.center.x=this._content.x=f-1,this._borders.center.y=this._content.y=d,this._borders.center.fillRect(0,0,b(e+3-2*f),b(a-2*d)),this.el.width=e,this.el.height=a,this.el.setOriginPoint("middle"),this},position:function(b,e){var d,a=this.scene.getCanvas();return void 0===b?{x:this.el.x,y:this.el.y}:(void 0===e?"middle"==b?(this.el.x=a.width/2-this.width/2,this.el.y=a.height/2-this.height/2):"bottom"==b?(this.el.x=a.width/2-this.width/2,this.el.y=a.height-this.height-.03*a.height):"top"==b?(this.el.x=a.width/2-this.width/2,this.el.y=.03*a.height):(d=b.match(/top+([0-9]+)/))?(this.el.x=a.width/2-this.width/2,this.el.y=d[1]):(d=b.match(/bottom-([0-9]+)/))&&(this.el.x=a.width/2-this.width/2,this.el.y=a.height-d[1]):(this.el.x=b,this.el.y=e),this)},setBackground:function(a,e,b){var d;return e||(e=0),b=b||1,d=this._borders.center,d.x=e,d.y=e,d.fillStyle=a,d.opacity=b,d.fillRect(0,0,this.width-2*e,this.height-2*e),this},getBox:function(){return this.el},getContent:function(){return this._content},open:function(a){return a.append(this.el),this},remove:function(){return this.el.remove(),this},cursor:{array_elements:null,el:null,index:0,params:{},_enable:!0,init:function(a,b,d){return a instanceof Array&&(b=a,a=null),this.params=CanvasEngine.extend(this.params,d),this.array_elements=b,this.el=a,this.update(),this},refresh:function(a,b){return this.array_elements=a,this.setIndex(this.index,b),this.update(),this},remove:function(){return this.el.remove(),this},assignKeys:function(e){function f(){if(b._enable){var g=b.array_elements[b.index];b._select&&g&&b._select.call(b,g)}}function a(g){var h=this.array_elements[g];h.width&&h.height&&this._enable&&(h.forceEvent(),h.on("touch",function(){b.setIndex(g),b.update(),f()}))}var b=this;e&&Global_CE.Input.reset(),Global_CE.Input.press([Input.Up],function(){b._enable&&b.setIndex(b.index-1)}),Global_CE.Input.press([Input.Bottom],function(){b._enable&&b.setIndex(b.index+1)}),Global_CE.Input.press(this.params.enter,f);for(var d=0;d<this.array_elements.length;d++)a.call(this,d);return this},getCurrentElement:function(){return this.array_elements[this.index]},setIndex:function(a,d){var b=this.array_elements.length;return 0>a?a=this.params.reverse?b-1:0:a>=b&&(a=this.params.reverse?0:b-1),this.index=a,this.update(!0),!0},update:function(a){if(this.el){if(0==this.array_elements.length)return void this.el.hide();this.el.show()}var d,b=this.getCurrentElement();b&&(d=b.position(),this.el&&(this.el.x=d.left,this.el.y=d.top),a&&this._onchange&&this.array_elements.length>0&&this._onchange.call(this,b))},enable:function(a){return void 0!=a&&(this._enable=a,a?this.assignKeys():Global_CE.Input.reset([Input.Enter,Input.Up,Input.bottom])),this._enable},change:function(a){return this._onchange=a,this},select:function(a){return this._select=a,this}}});var Window={Window:{New:function(){return this["new"].apply(this,arguments)},"new":function(e,d,a,b){return Class["new"]("Window",[e,d,a,b])}}};if("undefined"!=typeof exports)var CE=require("canvasengine").listen(),CanvasEngine=!1,Class=CE.Class;Class.create("Point",{initialize:function(b,a){this.x=b,this.y=a}}),Class.create("Polygon",{initialize:function(a){this.points=[],this.center=a},addPoint:function(a){this.points.push(a)},addAbsolutePoint:function(a){this.points.push({x:a.x-this.center.x,y:a.y-this.center.y})},getNumberOfSides:function(){return this.points.length},rotate:function(b){for(var d=0;d<this.points.length;d++){var a=this.points[d].x,e=this.points[d].y;this.points[d].x=Math.cos(b)*a-Math.sin(b)*e,this.points[d].y=Math.sin(b)*a+Math.cos(b)*e}},containsPoint:function(a){for(var l=this.points.length,n=a.x,m=a.y,g=new Array,b=0;b<this.points.length;b++)g.push(this.points[b].x+this.center.x);for(var f=new Array,k=0;k<this.points.length;k++)f.push(this.points[k].y+this.center.y);var e,d=0,h=!1;for(e=0,d=l-1;l>e;d=e++)f[e]>m!=f[d]>m&&n<(g[d]-g[e])*(m-f[e])/(f[d]-f[e])+g[e]&&(h=!h);return h},intersectsWith:function(g){function h(i,k){return{x:k.x+i.center.x,y:k.y+i.center.y}}function t(D,o,k){var C,B,A,i,E=[];for(C=0;C<g.getNumberOfSides();C++)B=h(g,g.points[C]),A=h(g,g.points[C+1]?g.points[C+1]:g.points[0]),i=Polygon.intersectLineLine(o,k,B,A),"Coincident"==i&&E.push({sides:C}),d[u].push(i);return u++,E}var w,p,n,m,l,e,v,f=Class.New("Point"),b=null,a=99999999;for(e=0;e<this.getNumberOfSides();e++){for(0==e?(f.x=this.points[this.getNumberOfSides()-1].y-this.points[0].y,f.y=this.points[0].x-this.points[this.getNumberOfSides()-1].x):(f.x=this.points[e-1].y-this.points[e].y,f.y=this.points[e].x-this.points[e-1].x),w=Math.sqrt(f.x*f.x+f.y*f.y),f.x/=w,f.y/=w,p=n=this.points[0].x*f.x+this.points[0].y*f.y,v=1;v<this.getNumberOfSides();v++)w=this.points[v].x*f.x+this.points[v].y*f.y,w>n?n=w:p>w&&(p=w);for(w=this.center.x*f.x+this.center.y*f.y,p+=w,n+=w,m=l=g.points[0].x*f.x+g.points[0].y*f.y,v=1;v<g.getNumberOfSides();v++)w=g.points[v].x*f.x+g.points[v].y*f.y,w>l?l=w:m>w&&(m=w);if(w=g.center.x*f.x+g.center.y*f.y,m+=w,l+=w,m>n||p>l)return!1;var r=n>m?n-m:l-p;a>r&&(a=r,b={x:f.x,y:f.y})}for(e=0;e<g.getNumberOfSides();e++){for(0==e?(f.x=g.points[g.getNumberOfSides()-1].y-g.points[0].y,f.y=g.points[0].x-g.points[g.getNumberOfSides()-1].x):(f.x=g.points[e-1].y-g.points[e].y,f.y=g.points[e].x-g.points[e-1].x),w=Math.sqrt(f.x*f.x+f.y*f.y),f.x/=w,f.y/=w,p=n=this.points[0].x*f.x+this.points[0].y*f.y,v=1;v<this.getNumberOfSides();v++)w=this.points[v].x*f.x+this.points[v].y*f.y,w>n?n=w:p>w&&(p=w);for(w=this.center.x*f.x+this.center.y*f.y,p+=w,n+=w,m=l=g.points[0].x*f.x+g.points[0].y*f.y,v=1;v<g.getNumberOfSides();v++)w=g.points[v].x*f.x+g.points[v].y*f.y,w>l?l=w:m>w&&(m=w);if(w=g.center.x*f.x+g.center.y*f.y,m+=w,l+=w,m>n||p>l)return!1;var r=n>m?n-m:l-p;a>r&&(a=r,b={x:f.x,y:f.y})}var z,y,q=[],d=[],u=0;for(v=0;v<this.getNumberOfSides();v++)d[u]=[],z=h(this,this.points[v]),y=h(this,this.points[v+1]?this.points[v+1]:this.points[0]),q.push(t(null,z,y));return{overlap:a+.001,axis:b,lines:d,coincident:q}}});var Polygon={};Polygon.intersectLineLine=function(f,d,k,i){var g=(i.x-k.x)*(f.y-k.y)-(i.y-k.y)*(f.x-k.x),h=(d.x-f.x)*(f.y-k.y)-(d.y-f.y)*(f.x-k.x),e=(i.y-k.y)*(d.x-f.x)-(i.x-k.x)*(d.y-f.y);if(0!=e){var b=g/e,a=h/e;return b>=0&&1>=b&&a>=0&&1>=a?{x:f.x+b*(d.x-f.x),y:f.y+b*(d.y-f.y)}:!1}return 0==g||0==h?"Coincident":"Parallel"},Class.create("EntityModel",{x:0,y:0,_memorize:{x:0,y:0},hitState:{over:0,out:0},_polygon:{},_frame:"0",position:function(a,d){if(void 0!==a&&void 0!==d){this.x=a,this.y=d;var b=this._polygon[this._frame];b&&(b.center.x=this.x,b.center.y=this.y)}return{x:this.x,y:this.y}},savePosition:function(){this._memorize.x=this.x,this._memorize.y=this.y},restorePosition:function(){this.x=this._memorize.x,this.y=this._memorize.y},polygon:function(d){d instanceof Array&&(d={0:d});for(var b in d){this._polygon[b]=Class.New("Polygon",[{x:d[b][0][0],y:d[b][0][1]}]);for(var a=0;a<d[b].length;a++)this._polygon[b].addPoint({x:d[b][a][0],y:d[b][a][1]})}},rect:function(a,e,b,d){b||d||(b=a,d=e,a=0,e=0),d||(d=b),this.polygon([[a,e],[a+b,e],[a+b,e+d],[a,e+d]])},hit:function(b){var a=this._polygon[this._frame].intersectsWith(b._polygon[b._frame]);return this.hitState.result=a,a?(this.hitState.out=0,this.hitState.over++):this.hitState.over>0?(this.hitState.out=1,this.hitState.over=0):(this.hitState.out=0,this.hitState.over=0),this.hitState},getPoints:function(a){return a=a||this._frame,this._polygon[a].points},getPolygonReg:function(a){return a=a||this._frame,this._polygon[a].center},getPolygon:function(a){return a=a||this._frame,this._polygon[a]},frame:function(a){return a&&(this._frame=a),this._frame}}),Class.create("Entity",{stage:null,params:{},el:null,mode:null,hit_entities:[],initialize:function(b,d,a){void 0===a&&(a=!0),this.stage=b,this.params=d,this.el=this.stage.getScene().createElement(),a&&this.setModel(Class.New("EntityModel")),this.testHit()},setModel:function(a){this.model=a},position:function(a,e,b){var d=this.model.position(a,e);return void 0!==a&&(this.el.x=d.x,this.el.y=d.y),{x:d.y,y:d.y}},move:function(a,d){var b=this.model.position();return a||(a=0),d||(d=0),this.position(a+b.x,d+b.y,!0)},polygon:function(a){this.model.polygon(a)},rect:function(a,e,b,d){this.model.rect(a,e,b,d),this.el.width=b,this.el.height=d},onHit:function(a,b,d){this.hit_entities=this.hit_entities.concat(b),this.el.on("entity:hit:"+a,d)},testHit:function(){var a=this;this.el.attr("entity:testHit",function(){a.hit(a.hit_entities)})},testAnimHit:function(){this.el.on("animation:draw",function(b){})},hit:function(f,g){function b(h){g&&g.call(a,h,a.el),a.el.trigger("entity:hit:"+h,[a.el])}for(var e,a=this,d=0;d<f.length;d++)e=this.model.hit(f[d].model),1==e.over?b("over"):1==e.out&&b("out")}});var Matrix={};Class.create("Grid",{_rows:0,_cols:0,cell:{width:0,height:0,prop:[]},_matrix:null,_transform:null,_func:null,initialize:function(a,b){a instanceof Array&&(this._matrix=a,this.cell.prop=a,b=a[0].length,a=a.length),this._rows=a,this._cols=b},transform:function(a){this._func=a},convert:function(a,b){return this._func?this._func.call(this,a,b):{x:a,y:b}},setPropertyCell:function(a){"undefined"!=typeof PF&&(this._pf_grid=!1,this._pf_prop=(CanvasEngine||CE.Core).rotateMatrix(a)),this.cell.prop=a},getPropertyByCell:function(a,b){return this.cell.prop[a]?this.cell.prop[a][b]:void 0},setPropertyByCell:function(a,b,d){return this.cell.prop[a]?(this.cell.prop[a][b]=d,"undefined"!=typeof PF&&(this._pf_grid=!1,this._pf_prop=(CanvasEngine||CE.Core).rotateMatrix(this.cell.prop)),this):void 0},getPropertyByPos:function(b,d){var a=this.getCellByPos(b,d);return this.getPropertyByCell(a.col,a.row)},testCell:function(l,h,f){function g(o,p){return{x:p.x+o.center.x,y:p.y+o.center.y}}function e(w,q,p,o){var u,A,y,B,r=[],z=null;for(u=0;u<o.getNumberOfSides();u++)A=g(o,o.points[u]),y=g(o,o.points[u+1]?o.points[u+1]:o.points[0]),B=Polygon.intersectLineLine(q,p,A,y),"Coincident"==B&&(q.x==A.x&&q.y==A.y?z={x:q.x,y:q.y}:p.x==y.x&&p.y==y.y?z={x:p.x,y:p.y}:q.x==y.x&&q.y==y.y?z={x:q.x,y:q.y}:p.x==A.x&&p.y==A.y&&(z={x:p.x,y:p.y}),r.push({sides:u,points:z}));return r}function k(o){return{x:o.x*m.cell.width,y:o.y*m.cell.height}}f=f||{},h.getPolygon||(h=h.model);var n=[],b=h.getPolygon(),m=this;l.getPolygon||(h=h.model);var d,a,i=[{y:l.row,x:l.col},{y:l.row,x:l.col+1},{y:l.row+1,x:l.col+1},{y:l.row+1,x:l.col}];for(j=0;j<i.length;j++)d=k(i[j]),a=k(i[j+1]?i[j+1]:i[0]),n.push(e(null,d,a,b));return n},getEntityCells:function(k,g){var l,h,d,q,e,a,n,m,t={min_x:99999999,max_x:0,min_y:99999999,max_y:0};for(g=g||{},k.model?(q=k.model.getPoints(),e=k.model.getPolygonReg(),a=k.model.getPolygon()):(q=k.getPoints(),e=k.getPolygonReg(),a=k.getPolygon()),l=0;l<q.length;l++)d=q[l],n=d.x+e.x,m=d.y+e.y,n<t.min_x&&(t.min_x=n),n>t.max_x&&(t.max_x=n),m<t.min_y&&(t.min_y=m),m>t.max_y&&(t.max_y=m);var o=[this.getCellByPos(t.min_x,t.min_y),this.getCellByPos(t.max_x,t.min_y),this.getCellByPos(t.max_x,t.max_y),this.getCellByPos(t.min_x,t.max_y)],f=o[2].row-o[0].row,r=o[1].col-o[0].col;for(l=0;r-1>l;l++)for(h=0;f-1>h;h++)o.push({row:o[0].row+h,col:o[0].col+l});return{cells:o}},getCellByPos:function(a,e){if(0==this.cell.width||0==this.cell.height)throw"Set the size of the cell prior with setCellSize method";var b=Math.floor(this.convert(a,e).x/this.cell.width),d=Math.floor(this.convert(a,e).y/this.cell.height);return{col:b,row:d}},setCellSize:function(a,b){this.cell.width=a,this.cell.height=b},getRows:function(){return this._rows},getCols:function(){return this._cols},getNbCell:function(){return this.getRows()*this.getCols()},passableCell:function(h,g,t,o){function d(){for(var E=0;2*k+1>E;E++){p[E]=[];for(var D=0;2*k+1>D;D++)p[E][D]=-1}var y=Math.floor(p.length/2);p[y][y]=0}function w(i,E){for(var D=0;D<o.length;D++)if(o[D][0]==i&&o[D][1]==E)return!0;return!1}o=o||[];var k=this._cols,m=(this._rows,this.cell.prop),p=[],A=[],b=[[h,g]],l=0,B=(b[0][0]-k,
b[0][1]-k,[]),n=0;for(d();0==!b.length&&t>l;){A=[];for(var r=0;r<b.length;r++)for(var v=b[r][0],u=b[r][1],a=v,C=u,q=0;4>q;q++)switch(q){case 0:void 0==m[v][u+1]||m[v][u+1]!=n||w(v,u+1)||-1!=p[a][C+1]||(A.push([v,u+1]),B.push([v,u+1]),p[a][C+1]=0);break;case 1:void 0==m[v+1]||void 0==m[v+1][u]||m[v+1][u]!=n||w(v+1,u)||-1!=p[a+1][C]||(A.push([v+1,u]),B.push([v+1,u]),p[a+1][C]=0);break;case 2:void 0==m[v][u-1]||m[v][u-1]!=n||w(v,u-1)||-1!=p[a][C-1]||(A.push([v,u-1]),B.push([v,u-1]),p[a][C-1]=0);break;case 3:void 0==m[v-1]||void 0==m[v-1][u]||m[v-1][u]!=n||w(v-1,u)||-1!=p[a-1][C]||(A.push([v-1,u]),B.push([v-1,u]),p[a-1][C]=0)}b=A,l+=1}return B},pathfinding:function(d,g,b,f,e,a){return e=e||"AStarFinder",this._pf_grid||(this._pf_grid=new PF.Grid(this._rows,this._cols,this._pf_prop)),void 0===d?this._pf_grid:new PF[e](a).findPath(d,g,b,f,this._pf_grid.clone())}});var Hit={Grid:{"new":function(a,b){return Class.New("Grid",[a,b])}}};"undefined"!=typeof exports&&(exports.Class=Hit),Class.create("Effect",{scene:null,el:null,canvas:null,initialize:function(b,a){if(this.scene=b,this.el=a,this.canvas=this.scene.getCanvas(),!Global_CE.Timeline)throw"Add Timeline class to use effects";return this},screenFlash:function(a,f,g){var d=this.scene.createElement(),b=this.scene.getCanvas();d.fillStyle=a,d.fillRect(0,0,b.width,b.height),d.opacity=.8,this.scene.getStage().append(d),d.zIndex(-1);var e=Global_CE.Timeline["new"](d);e.to({opacity:"0"},f).call(function(){d.remove(),g&&g()})},blink:function(d,b,f){var e=0,a=function(){d--,e++,e>=b&&(e=0,this.toggle()),0>=d&&(this.off("canvas:render",a),this.show(),f&&f())};this.el.on("canvas:render",a)},shake:function(d,e,h,b,i){"function"==typeof b&&(i=b,b=!1);var g=0,f=1;b=b||"x";var a=function(){var k=d*e*f/10;1>=h&&0>g*(g+k)?g=0:g+=k,g>2*d&&(f=-1),2*-d>g&&(f=1),h>=1&&(h-=1),/x/.test(b)&&(this.x=g),/y/.test(b)&&(this.y=g),0==h&&(this.off("canvas:render",a),i&&i()),console.log(k)};this.el.on("canvas:render",a)},changeScreenColorTone:function(a,e,g,d,f){var b=!1;this.tone&&(this.tone.remove(),delete this.tone,b=!0,"reset"==a)||(this.tone=this.scene.createElement(),canvas=this.scene.getCanvas(),this.tone.fillStyle=a,this.tone.fillRect(0,0,canvas.width,canvas.height),this.tone.opacity=0,this.tone.globalCompositeOperation=g,this.scene.getStage().append(this.tone),this.tone.zIndex(-1),b||(this.tone.opacity=0,e>0?Global_CE.Timeline["new"](this.tone).to({opacity:d},e).call(f):this.tone.opacity=d))},_weather:function(i,b){if("stop"==b.intensity)return clearInterval(this._weather_.timer),void(this._weather_.state="stop");var a=b.intensity||100,e=0,m=(this.scene.getStage(),this);this._weather_={number:0,numberStop:0,state:"loop"};var k=this.el.width||this.canvas.width,d=this.el.height||this.canvas.height,l=setInterval(function(){if(m._weather_.number==a)return void clearInterval(l);var n=m.scene.createElement();n.x=CanvasEngine.random(0,k),n.y=-10;var h;"rain"==i?(n.attr("drift",0),8*n.attr("speed",CanvasEngine.random(4,6)),n.width=n.height=5*CanvasEngine.random(2,6),h=m.canvas.createRadialGradient(n.height/2,n.height/2,0,n.height/2,n.height/2,n.height),h.addColorStop(0,"rgba(125, 125, 255, 1)"),h.addColorStop(1,"rgba(125, 125, 255, 0)"),n.beginPath(),n.moveTo(0,0),n.lineTo(e,n.height),n.strokeStyle=h,n.stroke()):(i="snow")&&(n.attr("drift",Math.random()),n.attr("speed",CanvasEngine.random(1,6)),n.width=n.height=CanvasEngine.random(2,6),b.use_gradient?(h=m.canvas.createRadialGradient(0,0,0,0,0,n.width),h.addColorStop(0,"rgba(255, 255, 255, 1)"),h.addColorStop(1,"rgba(255, 255, 255, 0)")):h="white",n.fillStyle=h,n.fillCircle()),n.name="weather",m.el.append(n),m._weather_.number++},200);this._weather_.timer=l;var g=function(h){if("weather"==h.name){if("finish"==m._weather_.state)return m.el.empty(),void m.el.off("canvas:refresh",g);if("stop"!=h.attr("flake_state")){if(h.y<d&&(h.y+=h.attr("speed")),h.y>d-3&&(h.y="snow"==i?-5:-30,"stop"==m._weather_.state))return h.attr("flake_state","stop"),m._weather_.numberStop++,void(m._weather_.number==m._weather_.numberStop&&(m._weather_.state="finish"));h.x+=h.attr("drift"),h.x>k&&(h.x=0)}}};return this.el.on("canvas:refresh",g),this},rain:function(a){return this._weather("rain",{intensity:a})},snow:function(a,b){return this._weather("snow",{intensity:a,use_gradient:b})},storm:function(a,f,d){function e(){var g=CanvasEngine.random(4,10);setTimeout(function(){"loop"==b._weather_.state&&(f&&f(),b.screenFlash(d,10),e())},1e3*g)}var b=this;return d=d||"#FCFFE6",this.rain(a),"stop"==a?this:void e()},particles:function(){}});var Effect={Effect:{New:function(){return this["new"].apply(this,arguments)},"new":function(b,a){return Class["new"]("Effect",[b,a])}}};Class.create("Text",{scene:null,text:"",el:null,_family:null,_style:{size:"20px",family:"Arial",weight:"normal",style:"normal",variant:"normal",color:"#000",transform:"none",decoration:"none",border:"none",lineHeight:25,shadow:null,textBaseline:"alphabetic",lineWidth:null},lines:[],initialize:function(a,b){this.scene=a,this.construct(b)},construct:function(a){a=""+a,this.el=this.scene.createElement(),a=this._transformHTML(a),this.text=a.split("\n"),this.lines=[]},_transformHTML:function(a){return a=a.replace(/<br>/g,"\n")},setImageText:function(d,g,b,a){this.scene.createElement();if(!Global_CE.Spritesheet)throw"Add Spritesheet class to use setImageText method";a=a||{rows:1,cols:1};var f=Global_CE.Spritesheet.New(d,{grid:[{size:a,tile:[b.width,b.height],set:g}]});this._family=f},style:function(b){b.size&!b.lineHeight&&(b.lineHeight=b.size);for(var a in b)this._style[a]=b[a];return this},draw:function(k,m,l,t){function C(y,i,n){return h=parseInt(q.lineHeight),h*=parseInt(q.size)/20,a=h*y,i.font=q.style+" "+q.weight+" "+q.variant+" "+q.size+" "+q.family,i.fillStyle=q.color,i.textBaseline=q.textBaseline,q.shadow&&(f=q.shadow.match(/(-?[0-9]+) (-?[0-9]+) ([0-9]+) ([#a-zA-Z0-9]+)/),f&&(i.shadowOffsetX=f[1],i.shadowOffsetY=f[2],i.shadowBlur=f[3],i.shadowColor=f[4])),i.fillText(n,0,a),"none"!=q.border&&(B=q.border.match(/([0-9]+)px ([#a-zA-Z0-9]+)/),i.font=q.style+" "+q.weight+" "+q.variant+" "+(q.size+B[1])+" "+q.family,i.strokeStyle=B[2],i.strokeText(n,0,a)),i}function r(y,n){var i=u.scene.createElement();C(y,i,n),u.lines.push({text:n,el:i,chars:[]}),i.opacity=0}function b(K,n,H){var L=this.lines[K].el;if(n>=this.lines[K].text.length){H();for(var G=0;G<this.lines[K].chars.length;G++)this.lines[K].chars[G].el.remove();return this.el.append(L),L.opacity=1,this.lines[K].el.opacity=1,void(t._char.onFinish&&t._char.onFinish())}var F=this.scene.createElement(),I=this.lines[K].text[n],y=d.measureText(I).width,J=this;C(K,F,I),F.x=n*y,F.opacity=0,this.el.append(F),this.lines[K].chars.push({_char:I,el:F}),Global_CE.Timeline["new"](F).to({opacity:1},t._char.frames).call(function(){t._char.onEffect&&t._char.onEffect(I,F),b.call(J,K,n+1,H)})}function z(y){var n,i=this;return y>=this.lines.length?void(t.line&&t.line.onFinish&&t.line.onFinish()):(n=this.lines[y].el,void(t.line?(this.el.append(n),Global_CE.Timeline["new"](n).to({opacity:1},t.line.frames).call(function(){t.line.onEffect&&t.line.onEffect(i.lines[y].text,n),z.call(i,y+1)})):t._char?b.call(this,y,0,function(){z.call(i,y+1)}):(n.opacity=1,this.el.append(n),z.call(this,y+1))))}if(t&&!Global_CE.Timeline)throw"Add Timeline class to use effects";t||(t={}),m||(m=0),l||(l=0);var B,p,A,h,f,q=this._style,a=0,g="",d=this.scene.getCanvas(),u=this;this.el.x=m,this.el.y=l;for(var A,E,o,v,e=0,D=0;D<this.text.length;D++)if(p=this.text[D],q.lineWidth){o=d.measureText(p,q.size,q.family).width,g="",v=p.split(" ");for(var w=0;w<v.length;w++)E=g+v[w]+" ",A=d.measureText(E,q.size,q.family),o=A.width,o>q.lineWidth?(r(e,g),g=v[w]+" ",e++):g=E;o<q.lineWidth&&(r(e,g),e++)}else r(D,p);return z.call(this,0),k.append(this.el),this.parent=k,this.pos={x:m,y:l},this},refresh:function(a){if(!this.parent)throw"Use 'draw' method before";return this.parent.empty(),this.construct(a),this.draw(this.parent,this.pos.x,this.pos.y),this},getNumberLines:function(){return this.lines.length}});var Text={Text:{New:function(){return this["new"].apply(this,arguments)},"new":function(a,b){return Class["new"]("Text",[a,b])}}};