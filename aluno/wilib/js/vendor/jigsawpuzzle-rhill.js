function stdout(s,clear){var consoleObj=self.document.getElementById("console");consoleObj&&(clear&&(consoleObj.innerHTML=""),consoleObj.innerHTML+=s+"<br>")}function stderr(s){self.debug_on&&stdout(s)}function Point(a,b,c){void 0!==b?(this.x=a,this.y=b,this.id=void 0!==c?c:0):a&&void 0!==a.x?(this.x=a.x,this.y=a.y,this.id=void 0!==a.id?a.id:0):this.x=this.y=this.id=0}function Segment(a,b){this.ptA=new Point(a),this.ptB=new Point(b)}function Bbox(a,b,c,d){if(void 0!==d)this.tl=new Point({x:a,y:b}),this.br=new Point({x:c,y:d});else if(void 0!==b){var mn=Math.min,mx=Math.max;this.tl=new Point({x:mn(a.x,b.x),y:mn(a.y,b.y)}),this.br=new Point({x:mx(a.x,b.x),y:mx(a.y,b.y)})}else a?(this.tl=new Point(a.tl),this.br=new Point(a.br)):(this.tl=new Point,this.br=new Point)}function Region(){this.bboxes=[]}function Bezier(a){Array.call(this),a instanceof Array&&(this[0]=a[0],this[1]=a[1],this[2]=a[2],this[3]=a[3],this[4]=a[4],this[5]=a[5])}function Profile(a){if(this.beziers=[],a&&void 0!==a.beziers)for(var beziers=a.beziers,nBeziers=beziers.length,iBezier=0;nBeziers>iBezier;iBezier++)this.beziers.push(new Bezier(beziers[iBezier]))}function ProfileRandomizer(profileNormalized,allowComplement,wobbleFactor){this.normalized=new Profile(profileNormalized),this.allowComplement=allowComplement,this.wobbleFactor=void 0!==wobbleFactor?wobbleFactor:0}function Side(a){a&&(void 0!==a.ptA&&void 0!==a.ptB&&(this.ptA=new Point(a.ptA),this.ptB=new Point(a.ptB)),this.profileNormalized=void 0!==a.profileNormalized?a.profileNormalized:new Profile(Profile.prototype.straight))}function Contour(a){if(this.sides=[],a){var iSide,nSides;if(a instanceof Contour){var sides=a.sides;for(nSides=sides.length,iSide=0;nSides>iSide;iSide++)this.sides.push(new Side(sides[iSide]));a.bbox&&(this.bbox=a.bbox.clone()),this.area=a.area,this.hole=a.hole}else if(a instanceof Array)for(nSides=a.length,iSide=0;nSides>iSide;iSide++)this.sides.push(new Side(a[iSide]));else alert("Contour ctor: Unknown arg 'a'")}}function Polygon(a){if(this.contours=[],a)if(a instanceof Polygon){for(var contours=a.contours,nContours=contours.length,iContour=0;nContours>iContour;iContour++)this.contours.push(new Contour(contours[iContour]));this.bbox&&(this.bbox=a.bbox.clone()),this.area=a.area,this.centroid&&(this.centroid=a.centroid.clone()),this.mostlyHollow=a.mostlyHollow}else a instanceof Array?this.contours.push(new Contour(a)):alert("Polygon ctor: Unknown arg 'a'")}function PuzzleTile(){this.polygon=null}function PuzzleSourceTile(img){PuzzleTile.call(this),this.sImage=img}function PuzzleTransientTile(sTile){PuzzleTile.call(this),this.sTile=sTile,this.angleStep=0,this.angleMaxSteps=1,this.angleRadians=6.28318530718}function PuzzleDisplayTile(tTile){PuzzleTile.call(this),this.tTile=tTile,this.dPos=new Point}function PuzzlePart(){}function PuzzlePiece(id,sides,img){this.id=id,this.sTile=new PuzzleSourceTile(img),this.sTile.setPolygon(sides),this.tTile=new PuzzleTransientTile(this.sTile),this.dTile=new PuzzleDisplayTile(this.tTile),this.piece=!0,PuzzlePart.call(this)}function PuzzlePreview(img){this.preview=!0,this.source=img,this.shadow=8,this.size=160,this.bbox=new Bbox(0,0,0,0)}function Puzzle(id,puzzleOptions){var me=this;if(this.confine=function(v,l,h,d){return void 0!==v?self.Math.max(self.Math.min(v,h),l):d},this.create=function(puzzleOptions){var defaultOptions={view:"full",cut:"classic",screenSize:"wilivro",src:"https://www.google.com.br/images/srpr/logo3w.png",numPieces:4,complexity:1,numRotateSteps:{full:1,mini:1},showPreview:!1,callBack:null,callBacks:null,callBacks_aux:0,altura:300,largura:300};if(this.config={},this.config.callBack=puzzleOptions&&puzzleOptions.callBack?puzzleOptions.callBack:defaultOptions.callBack,this.config.callBacks=puzzleOptions&&puzzleOptions.callBacks?puzzleOptions.callBacks:defaultOptions.callBacks,this.config.callBacks_aux=puzzleOptions&&puzzleOptions.callBacks_aux?puzzleOptions.callBacks_aux:defaultOptions.callBacks_aux,this.config.view=puzzleOptions&&puzzleOptions.view?puzzleOptions.view:defaultOptions.view,this.config.cookieName="jigsawpuzzle_rhill_"+this.config.view,puzzleOptions?puzzleOptions.key?puzzleOptions=this.parseKey(puzzleOptions.key):puzzleOptions.src||puzzleOptions.bedWidth||(puzzleOptions=this.restoreKey(this.config.cookieName)):puzzleOptions=this.restoreKey(this.config.cookieName),this.config.cut=void 0!==puzzleOptions.cut&&void 0!==Profile.prototype.stock[puzzleOptions.cut]?puzzleOptions.cut:defaultOptions.cut,this.config.backgroundColor=puzzleOptions.backgroundColor?puzzleOptions.backgroundColor:this.canvasParent.style.backgroundColor,this.config.showEdges=!1,this.config.showComposite=!1,this.config.showPreview=void 0!==puzzleOptions.showPreview?puzzleOptions.showPreview:!1,this.config.numPieces=(puzzleOptions&&puzzleOptions.numPieces?puzzleOptions.numPieces:defaultOptions.numPieces)-1,this.config.complexity=this.confine(puzzleOptions.complexity,0,9,defaultOptions.complexity),this.config.numRotateSteps=this.confine(puzzleOptions.numRotateSteps,1,90,defaultOptions.numRotateSteps[this.config.view]),this.config.screenSize=puzzleOptions.screenSize?puzzleOptions.screenSize:defaultOptions.screenSize,this.config.bedWidth=puzzleOptions&&puzzleOptions.largura?puzzleOptions.largura*getScale():defaultOptions.largura,this.config.bedHeight=puzzleOptions&&puzzleOptions.altura?puzzleOptions.altura*getScale():defaultOptions.altura,this.config.bedMargin=self.Math.round(.05*this.config.bedHeight),this.config.src=puzzleOptions.src&&puzzleOptions.src.length>0?puzzleOptions.src:defaultOptions.src,puzzleOptions.clusters&&(this.config.clusters=puzzleOptions.clusters),this.minPieceSize=40,this.minImageSize=2*this.minPieceSize,!this.canvas)throw"Puzzle.create(): No canvas";this.canvas.width=this.confine(this.config.bedWidth?this.config.bedWidth:this.canvasParent.offsetWidth,100,2500,768),this.canvas.height=this.confine(this.config.bedHeight?this.config.bedHeight:this.canvasParent.offsetHeight,100,2e3,576),this.canvasParent.style.width="0px",this.canvasParent.style.height="0px",this.imageSource=new Image,this.imageSource.onload=function(){me.init(me.config),this.onload=null},this.imageSource.src=this.config.src,this.pieces={},this.drawingStack=[],this.composites={}},this.shuffle=function(){for(var part,round=self.Math.round,random=self.Math.random,cw=this.canvas.width,ch=this.canvas.height,ipart=(cw-this.partWidth,ch-this.partHeight,this.partWidth>>1,this.partHeight>>1,0);ipart<this.drawingStack.length;ipart++)if(part=this.drawingStack[ipart],part.piece){if(part.composite){var partBbox=part.getDisplayBboxConst(),partWidth=partBbox.width(),partHeight=partBbox.height();part.setDisplayPos(round(random()*(cw-partWidth)+partWidth/2),round(random()*(ch-partHeight)+partHeight/2))}else{var partBbox=part.getDisplayBboxConst(),partWidth=partBbox.width(),partHeight=partBbox.height(),py=partBbox.height()>>1,px=(part.id-1)*partBbox.width()+(partBbox.width()>>1);px>cw&&(px%=cw,py=partBbox.height()*(px/cw+1));var fr=50;part.setDisplayPos(px+(random()*fr-fr/2),py+(random()*fr-fr/2))}part.setAngleStep(part.composite?0:round(random()*this.config.numRotateSteps),this.config.numRotateSteps)}},this.draw=function(clip){var ctx=me.canvas.getContext("2d");ctx.save(),ctx.fillStyle=me.config.backgroundColor,clip?(ctx.beginPath(),clip.toCanvasPath(ctx),ctx.clip(),ctx.fill()):ctx.fillRect(0,0,me.canvas.width,me.canvas.height),ctx.globalCompositeOperation="source-over";for(var part,imoved=me.imoved,showedges=me.config.showEdges,showComposite=me.config.showComposite,stack=me.drawingStack,nparts=stack.length,ipart=0;nparts>ipart;ipart++)part=stack[ipart],clip&&!part.doesIntersect(clip)||part.piece&&ipart!=imoved&&(showComposite&&!part.composite||showedges&&!part.isEdge())||part.draw(ctx);ctx.restore()},this.mergePieces=function(id,others){for(var otherId,parts=[],nOthers=others.length,iOther=0;nOthers>iOther;iOther++)otherId=others[iOther],parts.push(this.pieces[otherId]),delete this.pieces[otherId];this.pieces[id].merge(parts),this.composites[id]=this.pieces[id]},this.init=function(){this.canvas.style.cursor="wait";var round=self.Math.round,ceil=self.Math.ceil,sqrt=self.Math.sqrt,domax=self.Math.max,domin=self.Math.min,opts=this.config,iw=this.imageSource.width*getScale(),ih=this.imageSource.height*getScale(),cw=this.canvas.width,ch=this.canvas.height,imgRatio=iw/ih;if(iw<this.minImageSize||ih<this.minImageSize?imgRatio>=1?(iw=this.minImageSize,ih=round(iw/imgRatio)):(ih=this.minImageSize,iw=round(ih*imgRatio)):(iw>cw-2*opts.bedMargin||ih>ch-2*opts.bedMargin)&&(iw>cw-2*opts.bedMargin&&(iw=cw-2*opts.bedMargin,ih=round(iw/imgRatio)),ih>ch-2*opts.bedMargin&&(ih=ch-2*opts.bedMargin,iw=round(ih*imgRatio))),iw<this.minImageSize||ih<this.minImageSize||iw>cw-2*opts.bedMargin||ih>ch-2*opts.bedMargin)return void stdout("Because of its size, this image can't be used as a puzzle");stdout("Original image size (w &times; h): "+this.imageSource.width+"px &times; "+this.imageSource.height+"px"),iw==this.imageSource.width&&ih==this.imageSource.height||stdout("Resized to "+iw+"px &times; "+ih+"px");var numCols=domin(domax(ceil(sqrt(opts.numPieces)*sqrt(imgRatio)),2),round(iw/this.minPieceSize)),numRows=domin(domax(ceil(sqrt(opts.numPieces)/sqrt(imgRatio)),2),round(ih/this.minPieceSize));stdout("Actual number of pieces: "+numCols*numRows+" ("+numCols+" &times; "+numRows+" pieces)"),this.partWidth=round(iw/numCols),this.partHeight=round(ih/numRows),this.imageObj=self.document.createElement("canvas"),this.imageObj.width=iw,this.imageObj.height=ih;var ctx=this.imageObj.getContext("2d");ctx.drawImage(this.imageSource,0,0,this.imageSource.width,this.imageSource.height,0,0,iw,ih),this.drawingStack=[],this.pieces={},this.composites={},this.cut({width:iw,height:ih,numRows:numRows,numCols:numCols});var partid;if(this.config.clusters){for(var cluster,clusters=this.config.clusters,nClusters=clusters.length,iCluster=0;nClusters>iCluster;iCluster++)cluster=clusters[iCluster],partid=cluster.shift(),this.mergePieces(partid,cluster);delete this.config.clusters}for(partid in this.pieces)this.pieces.hasOwnProperty(partid)&&this.drawingStack.push(this.pieces[partid]);this.previewTile=new PuzzlePreview(this.imageObj),this.previewTile.setDisplayPos(cw-iw>>1,ch-ih>>1),this.previewTile.hidden=!opts.showPreview,this.drawingStack.push(this.previewTile),this.shuffle(),this.draw()},this.cut=function(parms){for(var edgeTop,edgeRight,edgeBottom,edgeLeft,piece,rand=self.Math.random,min=self.Math.min,max=self.Math.max,imgWidth=parms.width,imgHeight=parms.height,numRows=parms.numRows,numCols=parms.numCols,partWidth=imgWidth/numCols,partHeight=imgHeight/numRows,partWidthVar=partWidth*max(min(this.config.complexity,9),0)*.48/9,partHeightVar=partHeight*max(min(this.config.complexity,9),0)*.48/9,randomX=function(iPart){return self.Math.round(partWidth*(iPart+1)+2*partWidthVar*rand()-partWidthVar)},randomY=function(iPart){return self.Math.round(partHeight*(iPart+1)+2*partHeightVar*rand()-partHeightVar)},vid=1,pid=1,sides=[],top=0,right=1,bottom=2,profileStraight=new Profile(Profile.prototype.stock.straight),profileRandomizer=new ProfileRandomizer(Profile.prototype.stock[this.config.cut],!0),iRow=0;numRows>iRow;iRow++){sides[iRow]=[];for(var iCol=0;numCols>iCol;iCol++)edgeTop=new Side(0===iRow?{ptA:0===iCol?{x:0,y:0,id:vid++}:sides[iRow][iCol-1][top].endPointConst(),ptB:{x:iCol==numCols-1?imgWidth:randomX(iCol),y:0,id:vid++},profileNormalized:profileStraight}:sides[iRow-1][iCol][bottom].complement()),edgeRight=new Side({ptA:edgeTop.endPointConst(),ptB:{x:iCol==numCols-1?imgWidth:randomX(iCol),y:iRow==numRows-1?imgHeight:randomY(iRow),id:vid++},profileNormalized:iCol==numCols-1?profileStraight:profileRandomizer.randomize()}),edgeBottom=new Side({ptA:edgeRight.endPointConst(),ptB:0===iCol?{x:0,y:iRow==numRows-1?imgHeight:randomY(iRow),id:vid++}:sides[iRow][iCol-1][bottom].startPointConst(),profileNormalized:iRow==numRows-1?profileStraight:profileRandomizer.randomize()}),edgeLeft=new Side(0===iCol?{ptA:edgeBottom.endPointConst(),ptB:edgeTop.startPointConst(),profileNormalized:profileStraight}:sides[iRow][iCol-1][right].complement()),sides[iRow][iCol]=[edgeTop,edgeRight,edgeBottom,edgeLeft],piece=new PuzzlePiece(pid++,sides[iRow][iCol],this.imageObj),piece.edge=0===iRow||0===iCol||iRow==numRows-1||iCol==numCols-1,this.pieces[piece.id]=piece}},this.partUnderPoint=function(p){for(var part,stack=this.drawingStack,iPart=stack.length;--iPart>=0&&(part=stack[iPart],!part.pointIn(p)||part.hidden||part.piece&&this.config.showEdges&&!part.isEdge()););return iPart},this.sendBack=function(ipart){if(ipart>=0){var movedPart=this.drawingStack[ipart];this.drawingStack.splice(ipart,1),this.drawingStack.unshift(movedPart)}return 0},this.sendTop=function(ipart){if(ipart>=0&&ipart<this.drawingStack.length-2){var movedPart=this.drawingStack[ipart];this.drawingStack.splice(ipart,1),ipart=this.drawingStack.length-1,this.drawingStack.splice(ipart,0,movedPart)}return ipart},this.normalizeEventPos=function(e){e||(e=self.event);var pos=new Point;return pos.x=e.clientX-$(me.canvas).offset().left,pos.y=e.clientY-$(me.canvas).offset().top,pos},this.normalizeEventPosXY=function(x,y){var pos=new Point;return pos.x=x-$(me.canvas).offset().left,pos.y=y-$(me.canvas).offset().top,pos},this.isSolved=function(){return me.drawingStack.length<=2},this.partidToIndex=function(id){for(var part,n=this.drawingStack.length,i=0;n>i;i++)if(part=this.drawingStack[i],part.piece&&part.id==id)return i;return-1},this.parseKey=function(key){var r={};if(!key||!key.length)return r;var streamParts=key.split("++");if(streamParts.length>0&&(r=gadgets.json.parse(gadgets.Base64.decodeString(streamParts[0])),streamParts.length>1)){r.clusters=[];for(var clusters=streamParts[1].split("+"),iCluster=0;iCluster<clusters.length;iCluster++)r.clusters.push(gadgets.Base64.decode10bit(clusters[iCluster]))}return r},this.restoreKey=function(keyName){var prefs=new gadgets.Prefs;return this.parseKey(prefs.getString(keyName))},this.snapPiece=function(iTarget){var stack=this.drawingStack,nParts=stack.length,target=stack[iTarget],targetBbox=target.getDisplayBbox();targetBbox.inflate(5);for(var iPart=0;nParts>iPart;iPart++)if(iPart!=iTarget){var part=stack[iPart];if(part.piece&&part.getAngleStep()==target.getAngleStep()&&targetBbox.doesIntersect(part.getDisplayBboxConst())&&part.snapPiece(target))return this.composites||(this.composites={}),this.composites[part.id]=part,delete this.composites[target.id],this.drawingStack.splice(iTarget,1),this.isSolved()&&this.drawingStack.pop(),this.draw(),this.config.callBack&&this.isSolved()&&this.config.callBack(),this.config.callBacks&&this.config.callBacks.length>0&&this.config.callBacks.length>this.config.callBacks_aux&&(this.config.callBacks[this.config.callBacks_aux](),this.config.callBacks_aux++),!0}return!1},this.syncUI=function(){this.config},this.canvasParent=self.document.getElementById(id),this.canvasParent&&(this.canvas=self.document.getElementById("puzzleCanvas"),(this.canvas||(this.canvas=self.document.createElement("canvas"),this.canvas))&&this.canvas.getContext)){this.canvas.puzzle=me,this.canvasParent.style.backgroundColor="#fff",this.canvasParent.innerHTML="",this.canvasParent.appendChild(this.canvas),this.imoved=-1,this.movedAnchor=new Point,this.drawingStack=[];for(var elems=document.querySelectorAll('[id^="puzzle"]'),iElem=0;iElem<elems.length;iElem++){var e=elems[iElem];this[e.id]=e}this.puzzleShowPreview=function(){me.config.showPreview=!me.config.showPreview,me.previewTile&&(me.previewTile.hidden=!me.config.showPreview),me.syncUI(),me.draw()},this.presetClickHandler=function(){var parms={view:"full",src:this.src.replace("thumbnail-","full-"),cut:"classic",screenSize:me.puzzlePreferredSize.value,numPieces:me.puzzlePreferredNumPieces.value,complexity:1,rotate:24,showPreview:!1},prefs=new self.gadgets.Prefs;prefs.set("jigsawpuzzle_rhill_prefs",'{"size":"'+me.puzzlePreferredSize.value+'","numPieces":'+me.puzzlePreferredNumPieces.value+"}"),me.create(parms),self.puzzleGadgetTabs.setSelectedTab(0),me.draw()},this.create(puzzleOptions),this.syncUI(),this.canvas.addEventListener("touchstart",function(e){if(e.preventDefault(),1==e.targetTouches.length){var touch=e.targetTouches[0],imoved=me.imoved;if(me.imoved=-1,imoved>=0)me.drawingStack[imoved].piece&&(me.snapPiece(imoved)||(me.config.showComposite=!1)),me.draw(),this.style.cursor="-moz-grab";else{var pos=me.normalizeEventPosXY(touch.pageX,touch.pageY),ipart=me.partUnderPoint(pos);if(ipart>=0){me.imoved=me.sendTop(ipart);var moved=me.drawingStack[me.imoved],dPos=moved.getDisplayPos();me.movedAnchor.x=pos.x-dPos.x,me.movedAnchor.y=pos.y-dPos.y,me.draw(moved.getDisplayBbox()),this.style.cursor="-moz-grabbing"}}}},!1),this.canvas.onclick2=function(e){var imoved=me.imoved;if(me.imoved=-1,imoved>=0)me.drawingStack[imoved].piece&&(me.snapPiece(imoved)||(me.config.showComposite=!1)),me.draw(),this.style.cursor="-moz-grab";else{var pos=me.normalizeEventPos(e),ipart=me.partUnderPoint(pos);if(ipart>=0){me.imoved=me.sendTop(ipart);var moved=me.drawingStack[me.imoved],dPos=moved.getDisplayPos();me.movedAnchor.x=pos.x-dPos.x,me.movedAnchor.y=pos.y-dPos.y,me.draw(moved.getDisplayBbox()),this.style.cursor="-moz-grabbing"}}},this.canvas.addEventListener("touchend",function(e){if(e.preventDefault(),1==e.targetTouches.length){var imoved=(e.targetTouches[0],me.imoved);me.imoved=-1,me.drawingStack[imoved]&&me.drawingStack[imoved].piece&&(me.snapPiece(imoved)||(me.config.showComposite=!1)),me.draw(),this.style.cursor="-moz-grab"}},!1),this.canvas.onmouseup=function(e){var imoved=me.imoved;me.imoved=-1,me.drawingStack[imoved]&&me.drawingStack[imoved].piece&&(me.snapPiece(imoved)||(me.config.showComposite=!1)),me.draw(),this.style.cursor="-moz-grab"},this.canvas.onmousedown=function(e){me.imoved;me.imoved=-1;var pos=me.normalizeEventPos(e),ipart=me.partUnderPoint(pos);if(ipart>=0){me.imoved=me.sendTop(ipart);var moved=me.drawingStack[me.imoved],dPos=moved.getDisplayPos();me.movedAnchor.x=pos.x-dPos.x,me.movedAnchor.y=pos.y-dPos.y,me.draw(moved.getDisplayBbox()),this.style.cursor="-moz-grabbing"}},this.canvas.addEventListener("touchmove",function(e){if(e.preventDefault(),1==e.targetTouches.length){var touch=e.targetTouches[0],pos=me.normalizeEventPosXY(touch.pageX,touch.pageY);if(me.imoved<0)this.style.cursor=me.partUnderPoint(pos)>=0?"-moz-grab":"auto";else{var moved=me.drawingStack[me.imoved],drawBbox=moved.getDisplayBbox();moved.setDisplayPos(pos.x-me.movedAnchor.x,pos.y-me.movedAnchor.y),drawBbox.union(moved.getDisplayBboxConst()),me.draw(drawBbox)}}},!1),this.canvas.onmousemove=function(e){var pos=me.normalizeEventPos(e);if(me.imoved<0)this.style.cursor=me.partUnderPoint(pos)>=0?"-moz-grab":"auto";else{var moved=me.drawingStack[me.imoved],drawBbox=moved.getDisplayBbox();moved.setDisplayPos(pos.x-me.movedAnchor.x,pos.y-me.movedAnchor.y),drawBbox.union(moved.getDisplayBboxConst()),me.draw(drawBbox)}},self.onkeypress=function(e){e||(e=self.window.event);var code=e.keyCode?e.keyCode:e.which?e.which:0;switch(code){case 37:case 65:case 97:case 39:case 68:case 100:case 38:case 87:case 119:case 40:case 83:case 115:if(me.imoved<0)return!0;var moved=me.drawingStack[me.imoved];if(!moved.piece)return!0;break;case 32:case 69:case 101:case 81:case 113:break;default:return!0}var drawBbox;switch(code){case 37:case 65:case 97:if(me.config.numRotateSteps<=1)return!0;drawBbox=moved.getDisplayBbox(),moved.setAngleStep(moved.getAngleStep()-1);break;case 39:case 68:case 100:if(me.config.numRotateSteps<=1)return!0;drawBbox=moved.getDisplayBbox(),moved.setAngleStep(moved.getAngleStep()+1);break;case 38:case 87:case 119:drawBbox=moved.getDisplayBbox(),me.imoved=me.sendTop(me.imoved);break;case 40:case 83:case 115:drawBbox=moved.getDisplayBbox(),me.imoved=me.sendBack(me.imoved);break;case 32:case 81:case 113:me.puzzleShowPreview();break;default:return!0}return drawBbox&&(drawBbox.union(moved.getDisplayBboxConst()),me.draw(drawBbox)),!1}}}Point.prototype.toString=function(){return"{x:"+this.x+",y:"+this.y+",id:"+this.id+"}"},Point.prototype.toHashkey=function(){return this.x+"_"+this.y},Point.prototype.clone=function(){return new Point(this)},Point.prototype.offset=function(dx,dy){this.x+=dx,this.y+=dy},Point.prototype.set=function(a){this.x=a.x,this.y=a.y,this.id=void 0!==a.id?a.id:0},Point.prototype.compare=function(other,strict){return this.x==other.x&&this.y==other.y&&(!strict||this.id==other.id)},Segment.prototype.toString=function(){return"["+this.ptA+","+this.ptB+"]"},Segment.prototype.compare=function(other){return this.ptA.compare(other.ptA)&&this.ptB.compare(other.ptB)||this.ptA.compare(other.ptB)&&this.ptB.compare(other.ptA)},Bbox.prototype.toString=function(){return"{tl:"+this.tl+",br:"+this.br+"}"},Bbox.prototype.clone=function(){return new Bbox(this)},Bbox.prototype.getTopleft=function(){return new Point(this.tl)},Bbox.prototype.getBottomright=function(){return new Point(this.br)},Bbox.prototype.unionPoint=function(p){var mn=Math.min,mx=Math.max;this.tl.x=mn(this.tl.x,p.x),this.tl.y=mn(this.tl.y,p.y),this.br.x=mx(this.br.x,p.x),this.br.y=mx(this.br.y,p.y)},Bbox.prototype.unionPoints=function(a){if(a instanceof Array)for(var x,y,mx=self.Math.max,mn=self.Math.min,i=0;i<a.length;i+=2)x=a[i],y=a[i+1],this.tl.x=mn(this.tl.x,x),this.tl.y=mn(this.tl.y,y),this.br.x=mx(this.br.x,x),this.br.y=mx(this.br.y,y)},Bbox.prototype.width=function(){return this.br.x-this.tl.x},Bbox.prototype.height=function(){return this.br.y-this.tl.y},Bbox.prototype.offset=function(dx,dy){this.tl.offset(dx,dy),this.br.offset(dx,dy)},Bbox.prototype.set=function(a){if(a&&a instanceof Array&&a.length>0){var i,mx=self.Math.max,mn=self.Math.min;if(void 0!==a[0].x){this.tl.x=this.br.x=a[0].x,this.tl.y=this.br.y=a[0].y;var p;for(i=1;i<a.length;i++)p=a[i],this.tl.x=mn(this.tl.x,p.x),this.tl.y=mn(this.tl.y,p.y),this.br.x=mx(this.br.x,p.x),this.br.y=mx(this.br.y,p.y)}else{var x,y;for(i=0;i<a.length;i+=2)x=a[i],y=a[i+1],this.tl.x=mn(this.tl.x,x),this.tl.y=mn(this.tl.y,y),this.br.x=mx(this.br.x,x),this.br.y=mx(this.br.y,y)}}},Bbox.prototype.pointIn=function(p){return p.x>this.tl.x&&p.x<this.br.x&&p.y>this.tl.y&&p.y<this.br.y},Bbox.prototype.doesIntersect=function(bb){var mn=self.Math.min,mx=self.Math.max,retorno=mn(bb.br.x,this.br.x)-mx(bb.tl.x,this.tl.x)>0&&mn(bb.br.y,this.br.y)-mx(bb.tl.y,this.tl.y)>0;return retorno},Bbox.prototype.union=function(other){if(this.isEmpty())this.tl=new Point(other.tl),this.br=new Point(other.br);else if(!other.isEmpty()){var mn=self.Math.min,mx=self.Math.max;this.tl.x=mn(this.tl.x,other.tl.x),this.tl.y=mn(this.tl.y,other.tl.y),this.br.x=mx(this.br.x,other.br.x),this.br.y=mx(this.br.y,other.br.y)}return this},Bbox.prototype.inflate=function(a){this.tl.x-=a,this.tl.y-=a,this.br.x+=a,this.br.y+=a},Bbox.prototype.isEmpty=function(){return this.width()<=0||this.height()<=0},Bbox.prototype.toCanvasPath=function(ctx){ctx.rect(this.tl.x,this.tl.y,this.width(),this.height())},Region.prototype.add=function(tl,br){this.bboxes.push(new Bbox(tl,br))},Region.prototype.fill=function(ctx,fillStyle,clip){ctx.fillStyle=fillStyle;for(var i=0;i<this.bboxes.length;i++){var bbox=this.bboxes[i];void 0!==clip&&clip&&!bbox.doesIntersect(clip)||ctx.fillRect(bbox.tl.x,bbox.tl.y,bbox.width(),bbox.height())}},Bezier.prototype=[],Profile.prototype.getBboxConst=function(){if(!this.bbox){var beziers=this.beziers,nBeziers=beziers.length;if(nBeziers>0){this.bbox=new Bbox,this.bbox.set(beziers[0]);for(var iBezier=1;nBeziers>iBezier;iBezier++)this.bbox.unionPoints(beziers[iBezier])}else this.bbox=new Bbox}return this.bbox},Profile.prototype.getBbox=function(){return new Bbox(this.getBboxConst())},Profile.prototype.complement=function(){for(var bezier,nx,ny,r=new Profile(this),beziers=r.beziers,nBeziers=beziers.length,x=1024,y=0,iBezier=0;nBeziers>iBezier;iBezier++)bezier=beziers[iBezier],nx=bezier[4],ny=bezier[5],bezier[4]=x,bezier[5]=y,x=1024-bezier[0],y=-bezier[1],bezier[0]=1024-bezier[2],bezier[1]=-bezier[3],bezier[2]=x,bezier[3]=y,x=1024-nx,y=-ny;return beziers.reverse(),r},Profile.prototype.transform=function(ptA,ptB){for(var bezier,cx1,cy1,cx2,cy2,x,y,r=new Profile,round=self.Math.round,scale=self.Math.sqrt(self.Math.pow(ptB.x-ptA.x,2)+self.Math.pow(ptB.y-ptA.y,2))/1024,angle=self.Math.atan2(ptB.y-ptA.y,ptB.x-ptA.x),cosang=self.Math.cos(angle),sinang=self.Math.sin(angle),beziers=this.beziers,nBeziers=beziers.length,iBezier=0;nBeziers>iBezier;iBezier++)bezier=beziers[iBezier],x=bezier[0]*scale,y=bezier[1]*scale,cx1=round(x*cosang-y*sinang),cy1=round(x*sinang+y*cosang),x=bezier[2]*scale,y=bezier[3]*scale,cx2=round(x*cosang-y*sinang),cy2=round(x*sinang+y*cosang),x=bezier[4]*scale,y=bezier[5]*scale,r.beziers.push([cx1,cy1,cx2,cy2,round(x*cosang-y*sinang),round(x*sinang+y*cosang)]);return r},Profile.prototype.toCanvas=function(ctx,ptA,ptB){if(this.beziers.length)for(var bezier,x0=ptA.x,y0=ptA.y,beziers=this.beziers,nBeziers=beziers.length,iBezier=0;nBeziers>iBezier;iBezier++)bezier=this.beziers[iBezier],ctx.bezierCurveTo(x0+bezier[0],y0+bezier[1],x0+bezier[2],y0+bezier[3],x0+bezier[4],y0+bezier[5]);else ctx.lineTo(ptB.x,ptB.y)},Profile.prototype.stock={straight:{beziers:[[0,0,1024,0,1024,0]]},classic:{beziers:[[0,0,448,-224,448,-96],[448,-32,384,-32,384,64],[384,160,448,192,512,192],[576,192,640,160,640,64],[640,-32,576,-32,576,-96],[576,-224,1024,0,1024,0]]},wave:{beziers:[[128,128,192,-96,320,0],[352,32,224,96,256,128],[448,224,576,-224,768,-128],[800,-96,672,-32,704,0],[832,96,896,-128,1024,0]]},tenon:{beziers:[[0,0,224,0,224,0],[224,0,224,192,224,192],[224,192,416,192,416,192],[416,192,416,0,416,0],[416,0,608,0,608,0],[608,0,608,192,608,192],[608,192,800,192,800,192],[800,192,800,0,800,0],[800,0,1024,0,1024,0]]}},ProfileRandomizer.prototype.randomize=function(){var r;return r=this.allowComplement&&self.Math.random()>=.5?this.normalized.complement():new Profile(this.normalized)},Side.prototype.clone=function(){return new Side(this)},Side.prototype.complement=function(){var side=new Side;return side.ptB=new Point(this.ptA),side.ptA=new Point(this.ptB),side.profileNormalized=this.profileNormalized.complement(),side},Side.prototype.startPointConst=function(){return this.ptA},Side.prototype.endPointConst=function(){return this.ptB},Side.prototype.offset=function(dx,dy){this.ptA.offset(dx,dy),this.ptB.offset(dx,dy),this.bbox&&this.bbox.offset(dx,dy)},Side.prototype.sync=function(){this.profile||(this.profile=this.profileNormalized.transform(this.ptA,this.ptB))},Side.prototype.getBboxConst=function(){return this.bbox||(this.profile||this.sync(),this.bbox=this.profile.getBbox(),this.bbox.offset(this.ptA.x,this.ptA.y),0===this.bbox.width()?this.ptA.y<this.ptB.y?this.bbox.tl.x--:this.bbox.br.x++:0===this.bbox.height()&&(this.ptA.x<this.ptB.x?this.bbox.br.y++:this.bbox.tl.y--)),this.bbox},Side.prototype.getBbox=function(){return new Bbox(this.getBboxConst())},Side.prototype.rotate=function(angle,x0,y0,cosang,sinang){void 0===cosang&&(cosang=self.Math.cos(angle)),void 0===sinang&&(sinang=self.Math.sin(angle));var round=self.Math.round,x=this.ptA.x-x0,y=this.ptA.y-y0;this.ptA.x=round(x*cosang-y*sinang)+x0,this.ptA.y=round(x*sinang+y*cosang)+y0,x=this.ptB.x-x0,y=this.ptB.y-y0,this.ptB.x=round(x*cosang-y*sinang)+x0,this.ptB.y=round(x*sinang+y*cosang)+y0,delete this.profile,delete this.bbox},Side.prototype.toCanvas=function(ctx){this.profile||this.sync(),this.profile.toCanvas(ctx,this.ptA,this.ptB)},Side.prototype.draw3dEdge=function(ctx){this.profile||this.sync();for(var xb,yb,bezier,dx,dy,g,abs=self.Math.abs,rnd=self.Math.round,atan=self.Math.atan2,beziers=this.profile.beziers,nBeziers=beziers.length,ptA=this.ptA,x0=ptA.x,y0=ptA.y,xa=0,ya=0,iBezier=0;nBeziers>iBezier;iBezier++)bezier=beziers[iBezier],xb=bezier[4],yb=bezier[5],dx=.70710678*(xb-xa),dy=.70710678*(yb-ya),g=abs(rnd(81.16902098*atan(dx+dy,dy-dx))),g=16>g?"0"+g.toString(16):g.toString(16),ctx.strokeStyle="#"+g+g+g,ctx.beginPath(),ctx.moveTo(x0+xa,y0+ya),ctx.bezierCurveTo(x0+bezier[0],y0+bezier[1],x0+bezier[2],y0+bezier[3],x0+xb,y0+yb),ctx.stroke(),xa=xb,ya=yb},Contour.prototype.clone=function(){return new Contour(this)},Contour.prototype.addSide=function(side){this.sides.push(new Side(side)),delete this.bbox,delete this.area,delete this.hole},Contour.prototype.getBbox=function(){return new Bbox(this.getBboxConst())},Contour.prototype.getBboxConst=function(){if(!this.bbox){this.bbox=new Bbox;for(var sides=this.sides,nSides=sides.length,iSide=0;nSides>iSide;iSide++)this.bbox.union(sides[iSide].getBboxConst())}return this.bbox},Contour.prototype.offset=function(dx,dy){for(var sides=this.sides,nSides=sides.length,iSide=0;nSides>iSide;iSide++)sides[iSide].offset(dx,dy);this.bbox&&this.bbox.offset(dx,dy)},Contour.prototype.isHollow=function(){return void 0===this.hole&&(this.hole=this.getArea()>0),this.hole},Contour.prototype.getArea=function(){if(void 0===this.area){for(var side,ptA,ptB,area=0,sides=this.sides,nSides=sides.length,iSide=0;nSides>iSide;iSide++)side=sides[iSide],ptA=side.ptA,ptB=side.ptB,area+=ptA.x*ptB.y,area-=ptA.y*ptB.x;this.area=area/2}return this.area},Contour.prototype.rotate=function(angle,x0,y0,cosang,sinang){void 0===cosang&&(cosang=self.Math.cos(angle)),void 0===sinang&&(sinang=self.Math.sin(angle));for(var sides=this.sides,nSides=sides.length,iSide=0;nSides>iSide;iSide++)sides[iSide].rotate(angle,x0,y0,cosang,sinang);delete this.bbox},Contour.prototype.toCanvas=function(ctx){var sides=this.sides,nSides=sides.length;if(0!==nSides){var pt=sides[0].ptA;ctx.moveTo(pt.x,pt.y);for(var iSide=0;nSides>iSide;iSide++)sides[iSide].toCanvas(ctx);ctx.closePath()}},Contour.prototype.draw3dEdge=function(ctx){for(var sides=this.sides,nSides=sides.length,iSide=0;nSides>iSide;iSide++)sides[iSide].draw3dEdge(ctx)},Polygon.prototype.clone=function(){return new Polygon(this)},Polygon.prototype.getBbox=function(){if(!this.bbox){this.bbox=new Bbox;for(var contours=this.contours,nContours=contours.length,iContour=0;nContours>iContour;iContour++)this.bbox.union(contours[iContour].getBboxConst())}return this.bbox.clone()},Polygon.prototype.getArea=function(){if(!this.area){for(var area=0,contours=this.contours,nContours=contours.length,iContour=0;nContours>iContour;iContour++)area+=contours[iContour].getArea();this.area=area}return this.area},Polygon.prototype.getCentroid=function(){if(!this.centroid){for(var sides,nSides,iSide,side,ptA,ptB,f,contours=this.contours,nContours=contours.length,x=0,y=0,iContour=0;nContours>iContour;iContour++)for(sides=contours[iContour].sides,nSides=sides.length,iSide=0;nSides>iSide;iSide++)side=sides[iSide],ptA=side.ptA,ptB=side.ptB,f=ptA.x*ptB.y-ptB.x*ptA.y,x+=(ptA.x+ptB.x)*f,y+=(ptA.y+ptB.y)*f;f=6*this.getArea();var origin=this.getBbox().getTopleft(),rnd=self.Math.round;this.centroid=new Point({x:rnd(x/f-origin.x),y:rnd(y/f-origin.y)})}return this.centroid.clone()},Polygon.prototype.pointIn=function(p){alert("Polygon.prototype.pointIn: No longer supported")},Polygon.prototype.offset=function(dx,dy){for(var contours=this.contours,nContours=contours.length,iContour=0;nContours>iContour;iContour++)contours[iContour].offset(dx,dy);this.bbox&&this.bbox.offset(dx,dy),this.centroid&&this.centroid.offset(dx,dy)},Polygon.prototype.moveto=function(x,y){var centroid=this.getCentroid(),tl=this.getBbox().getTopLeft();this.offset(x-tl.x-centroid.x,y-tl.y-centroid.y)},Polygon.prototype.rotate=function(angle,x0,y0){for(var cosang=self.Math.cos(angle),sinang=self.Math.sin(angle),contours=this.contours,nContours=contours.length,iContour=0;nContours>iContour;iContour++)contours[iContour].rotate(angle,x0,y0,cosang,sinang);delete this.bbox,delete this.centroid},Polygon.prototype.doesIntersect=function(bbox){return this.getBbox().doesIntersect(bbox)},Polygon.prototype.isMostlyHollow=function(){if(void 0===this.mostlyHollow){for(var area,areaSolid=0,areaHollow=0,contours=this.contours,nContours=contours.length,iContour=0;nContours>iContour;iContour++)area=contours[iContour].getArea(),0>area?areaSolid+=area:areaHollow+=area;
this.mostlyHollow=areaHollow>areaSolid}return this.mostlyHollow},Polygon.prototype.getSides=function(){for(var contour,sides,nSides,iSide,r=[],contours=this.contours,nContours=contours.length,iContour=0;nContours>iContour;iContour++)for(contour=contours[iContour],sides=contour.sides,nSides=sides.length,iSide=0;nSides>iSide;iSide++)r.push(new Side(sides[iSide]));return r},Polygon.prototype.getSidesConst=function(){for(var contour,sides,nSides,iSide,r=[],contours=this.contours,nContours=contours.length,iContour=0;nContours>iContour;iContour++)for(contour=contours[iContour],sides=contour.sides,nSides=sides.length,iSide=0;nSides>iSide;iSide++)r.push(sides[iSide]);return r},Polygon.prototype.merge=function(others){for(var sides,nSides,iSide,side,idA,idB,pool={},contours=this.contours,nContours=contours.length,iContour=0;nContours>iContour;iContour++)for(sides=contours[iContour].sides,nSides=sides.length,iSide=0;nSides>iSide;iSide++)side=sides[iSide],idA=side.ptA.toHashkey(),idB=side.ptB.toHashkey(),pool[idA]?pool[idA].n++:pool[idA]={n:1,sides:{}},pool[idA].sides[idB]=side;for(var nPolygons=others.length,iPolygon=0;nPolygons>iPolygon;iPolygon++)for(contours=others[iPolygon].contours,nContours=contours.length,iContour=0;nContours>iContour;iContour++)for(sides=contours[iContour].sides,nSides=sides.length,iSide=0;nSides>iSide;iSide++)side=sides[iSide],idA=side.ptA.toHashkey(),idB=side.ptB.toHashkey(),pool[idB]&&pool[idB].sides[idA]?(delete pool[idB].sides[idA],--pool[idB].n||delete pool[idB]):(pool[idA]?pool[idA].n++:pool[idA]={n:1,sides:{}},pool[idA].sides[idB]=side);this.contours=[];var contour;for(idA in pool){contour=new Contour,this.contours.push(contour);for(idB in pool[idA].sides)break;for(side=pool[idA].sides[idB];side;)if(contour.addSide(side),delete pool[idA].sides[idB],--pool[idA].n||delete pool[idA],idA=side.ptB.toHashkey(),pool[idA]){for(idB in pool[idA].sides)break;side=pool[idA].sides[idB]}else side=null}delete this.bbox,delete this.area,delete this.centroid,delete this.mostlyHollow},Polygon.prototype.toCanvasPath=function(ctx){for(var contours=this.contours,nContours=contours.length,iContour=0;nContours>iContour;iContour++)contours[iContour].toCanvas(ctx)},Polygon.prototype.draw3dEdge=function(ctx){for(var contours=this.contours,nContours=contours.length,iContour=0;nContours>iContour;iContour++)contours[iContour].draw3dEdge(ctx)},PuzzleTile.prototype.setPolygon=function(sides){this.polygon||(this.polygon=new Polygon(sides))},PuzzleTile.prototype.getBbox=function(){return this.polygon.getBbox()},PuzzleTile.prototype.getCentroid=function(){return this.polygon.getCentroid()},PuzzleTile.prototype.getPolygon=function(){return this.polygon.clone()},PuzzleTile.prototype.getPolygonSides=function(){return this.polygon.getSides()},PuzzleTile.prototype.getPolygonSidesConst=function(){return this.polygon.getSidesConst()},PuzzleTile.prototype.merge=function(others){for(var polygons=[],nOthers=others.length,iOther=0;nOthers>iOther;iOther++)polygons.push(others[iOther].polygon);this.polygon.merge(polygons)},PuzzleSourceTile.prototype=new PuzzleTile,PuzzleSourceTile.prototype.getSourceImage=function(){return this.sImage},PuzzleTransientTile.prototype=new PuzzleTile,PuzzleTransientTile.prototype.getAngleStep=function(){return this.angleStep},PuzzleTransientTile.prototype.setAngleStep=function(step,maxSteps){void 0!==maxSteps&&(this.angleMaxSteps=360/self.Math.round(360/self.Math.min(self.Math.max(maxSteps,1),90))),this.angleStep=step%this.angleMaxSteps,this.angleStep<0&&(this.angleStep+=this.angleMaxSteps),this.angleRadians=6.28318530718*this.angleStep/this.angleMaxSteps,this.tImage=null},PuzzleTransientTile.prototype.sync=function(){if(!this.tImage){this.tImage=self.document.createElement("canvas"),this.polygon=this.sTile.polygon.clone();var sBbox=this.sTile.getBbox(),sTopleft=sBbox.getTopleft(),sCentroid=this.sTile.getCentroid();this.polygon.rotate(this.angleRadians,sTopleft.x+sCentroid.x,sTopleft.y+sCentroid.y);var tBbox=this.polygon.getBbox(),tTopleft=tBbox.getTopleft();this.polygon.offset(-tTopleft.x,-tTopleft.y);var tCentroid=this.polygon.getCentroid();this.tImage.width=tBbox.width(),this.tImage.height=tBbox.height();var ctx=this.tImage.getContext("2d");ctx.save(),ctx.beginPath(),this.polygon.toCanvasPath(ctx),ctx.clip(),ctx.save(),this.angleStep&&(ctx.translate(tCentroid.x,tCentroid.y),ctx.rotate(this.angleRadians),ctx.translate(-tCentroid.x,-tCentroid.y)),ctx.drawImage(this.sTile.getSourceImage(),sTopleft.x,sTopleft.y,sBbox.width(),sBbox.height(),tCentroid.x-sCentroid.x,tCentroid.y-sCentroid.y,sBbox.width(),sBbox.height()),ctx.restore(),ctx.globalAlpha=.9,ctx.lineWidth=1,this.polygon.draw3dEdge(ctx),ctx.restore()}},PuzzleTransientTile.prototype.getPolygon=function(){return this.tImage||this.sync(),PuzzleTile.prototype.getPolygon.call(this)},PuzzleTransientTile.prototype.getPolygonSides=function(){return this.tImage||this.sync(),PuzzleTile.prototype.getPolygonSides.call(this)},PuzzleTransientTile.prototype.getPolygonSidesConst=function(){return this.tImage||this.sync(),PuzzleTile.prototype.getPolygonSidesConst.call(this)},PuzzleTransientTile.prototype.getTransientImage=function(){return this.tImage||this.sync(),this.tImage},PuzzleTransientTile.prototype.getBbox=function(){return this.tImage||this.sync(),PuzzleTile.prototype.getBbox.call(this)},PuzzleTransientTile.prototype.getCentroid=function(){return this.tImage||this.sync(),PuzzleTile.prototype.getCentroid.call(this)},PuzzleTransientTile.prototype.pointIn=function(p){this.tImage||this.sync();var r=!1,ctx=this.tImage.getContext("2d");ctx.save(),ctx.beginPath();for(var contours=this.polygon.contours,nContours=contours.length,iContour=0;nContours>iContour;iContour++)contours[iContour].toCanvas(ctx);return r=ctx.isPointInPath(p.x,p.y),ctx.restore(),r},PuzzleTransientTile.prototype.merge=function(others){for(var sTiles=[],nOthers=others.length,iOther=0;nOthers>iOther;iOther++)sTiles.push(others[iOther].sTile);this.sTile.merge(sTiles),this.tImage=null},PuzzleDisplayTile.prototype=new PuzzleTile,PuzzleDisplayTile.prototype.getDisplayPos=function(){return new Point(this.dPos)},PuzzleDisplayTile.prototype.setDisplayPos=function(x,y){var dx=x-this.dPos.x,dy=y-this.dPos.y;this.dPos.set({x:x,y:y}),this.polygon&&this.polygon.offset(dx,dy),this.bbox&&this.bbox.offset(dx,dy)},PuzzleDisplayTile.prototype.getDisplayImage=function(){return this.tTile.getTransientImage()},PuzzleDisplayTile.prototype.getAngleStep=function(){return this.tTile.getAngleStep()},PuzzleDisplayTile.prototype.setAngleStep=function(step,maxSteps){this.tTile.setAngleStep(step,maxSteps),delete this.polygon,delete this.bbox},PuzzleDisplayTile.prototype.sync=function(){if(!this.polygon){this.polygon=this.tTile.getPolygon();var tCentroid=this.tTile.getCentroid();this.polygon.offset(this.dPos.x-tCentroid.x,this.dPos.y-tCentroid.y)}},PuzzleDisplayTile.prototype.getPolygonSides=function(){return this.polygon||this.sync(),PuzzleTile.prototype.getPolygonSides.call(this)},PuzzleDisplayTile.prototype.getPolygonSidesConst=function(){return this.polygon||this.sync(),PuzzleTile.prototype.getPolygonSidesConst.call(this)},PuzzleDisplayTile.prototype.getBbox=function(){return new Bbox(this.getBboxConst())},PuzzleDisplayTile.prototype.getBboxConst=function(){return this.bbox||(this.polygon||this.sync(),this.bbox=PuzzleTile.prototype.getBbox.call(this)),this.bbox},PuzzleDisplayTile.prototype.getCentroid=function(){return this.polygon||this.sync(),PuzzleTile.prototype.getCentroid.call(this)},PuzzleDisplayTile.prototype.pointIn=function(p){if(this.getBboxConst().pointIn(p)){var dPos=this.getBbox().getTopleft();return this.tTile.pointIn(new Point({x:p.x-dPos.x,y:p.y-dPos.y}))}return!1},PuzzleDisplayTile.prototype.merge=function(others){for(var tTiles=[],nOthers=others.length,iOther=0;nOthers>iOther;iOther++)tTiles.push(others[iOther].tTile);this.tTile.merge(tTiles),delete this.polygon,delete this.bbox},PuzzleDisplayTile.prototype.isMostlyHollow=function(){return this.polygon||this.sync(),this.polygon.isMostlyHollow()},PuzzlePiece.prototype=new PuzzlePart,PuzzlePiece.prototype.getAngleStep=function(){return this.dTile.getAngleStep()},PuzzlePiece.prototype.setAngleStep=function(step,numsteps){this.dTile.setAngleStep(step,numsteps)},PuzzlePiece.prototype.setDisplayPos=function(x,y){this.dTile.setDisplayPos(x,y)},PuzzlePiece.prototype.getDisplayPos=function(){return this.dTile.getDisplayPos()},PuzzlePiece.prototype.getDisplayBbox=function(){return this.dTile.getBbox()},PuzzlePiece.prototype.getDisplayBboxConst=function(){return this.dTile.getBboxConst()},PuzzlePiece.prototype.draw=function(ctx){var dImage=this.dTile.getDisplayImage(),dTopleft=this.dTile.getBbox().getTopleft();ctx.drawImage(dImage,dTopleft.x,dTopleft.y)},PuzzlePiece.prototype.pointIn=function(p){return this.dTile.pointIn(p)},PuzzlePiece.prototype.isEdge=function(){return this.edge},PuzzlePiece.prototype.doesIntersect=function(bbox){return bbox.doesIntersect(this.getDisplayBboxConst())},PuzzlePiece.prototype.merge=function(others){for(var other,dTiles=[],nOthers=others.length,iOther=0;nOthers>iOther;iOther++)other=others[iOther],dTiles.push(other.dTile),this.edge=this.edge||other.edge,this.composite||(this.composite=[this.id]),other.composite?this.composite=this.composite.concat(other.composite):this.composite.push(other.id);this.dTile.merge(dTiles)},PuzzlePiece.prototype.snapPiece=function(other){if(other.id==this.id)return!1;if(other.getAngleStep()!=this.getAngleStep())return!1;var dBbox=other.getDisplayBbox();if(dBbox.inflate(5),!dBbox.doesIntersect(this.getDisplayBboxConst()))return!1;for(var thisSide,otherSide,abs=self.Math.abs,thisSides=this.dTile.getPolygonSidesConst(),otherSides=other.dTile.getPolygonSidesConst(),nThisSides=thisSides.length,nOtherSides=otherSides.length,iThisSide=0;nThisSides>iThisSide;iThisSide++){thisSide=thisSides[iThisSide];for(var iOtherSide=0;nOtherSides>iOtherSide;iOtherSide++){otherSide=otherSides[iOtherSide];var coeficienteDificuldade=25;if(otherSide.ptA.id==thisSide.ptB.id&&otherSide.ptB.id==thisSide.ptA.id&&abs(otherSide.ptA.x-thisSide.ptB.x)<coeficienteDificuldade&&abs(otherSide.ptA.y-thisSide.ptB.y)<coeficienteDificuldade){var oldTopleft=this.getDisplayBbox().union(other.getDisplayBbox()).getTopleft();this.merge([other]);var newTopleft=this.getDisplayBbox().getTopleft(),newPos=this.getDisplayPos();return newPos.offset(oldTopleft.x-newTopleft.x,oldTopleft.y-newTopleft.y),this.setDisplayPos(newPos.x,newPos.y),!0}}}return!1},PuzzlePiece.prototype.isMostlyHollow=function(){return this.dTile.isMostlyHollow()},PuzzlePreview.prototype=new PuzzlePart,PuzzlePreview.prototype.draw=function(ctx){this.hidden||(ctx.save(),this.image||this.resize(),ctx.drawImage(this.image,this.bbox.tl.x,this.bbox.tl.y),ctx.restore())},PuzzlePreview.prototype.setDisplayPos=function(x,y){var topleft=this.bbox.getTopleft();this.bbox.offset(x-topleft.x,y-topleft.y)},PuzzlePreview.prototype.getDisplayPos=function(){return this.bbox.getTopleft()},PuzzlePreview.prototype.getDisplayBbox=function(){return new Bbox(this.bbox)},PuzzlePreview.prototype.getDisplayBboxConst=function(){return this.bbox},PuzzlePreview.prototype.pointIn=function(p){var noShadowBbox=new Bbox(this.bbox);return noShadowBbox.br.x-=this.shadow,noShadowBbox.br.y-=this.shadow,noShadowBbox.pointIn(p)},PuzzlePreview.prototype.doesIntersect=function(bbox){return this.bbox.doesIntersect(bbox)},PuzzlePreview.prototype.resize=function(sz){var w,h,math=self.Math;w=h=sz?sz:math.max(this.source.width,this.source.height);var ratio=this.source.width/this.source.height;ratio>=1?h/=ratio:w*=ratio,this.size=sz,w=math.round(w),h=math.round(h),this.image||(this.image=self.document.createElement("canvas")),this.image.width=w+this.shadow,this.image.height=h+this.shadow;var xpos=0,ypos=0;this.bbox&&(xpos=math.max(this.bbox.tl.x,0),ypos=math.max(this.bbox.tl.y,0)),this.bbox=new Bbox(xpos,ypos,xpos+w+this.shadow,ypos+h+this.shadow);var ctx=this.image.getContext("2d");ctx.drawImage(this.source,0,0,w,h),ctx.save(),ctx.beginPath(),ctx.rect(0,0,w,h),ctx.clip(),ctx.strokeStyle="#ccc",ctx.lineWidth=2,ctx.globalAlpha=.8,ctx.strokeRect(0,0,w,h),ctx.restore(),ctx.fillStyle="#000",ctx.globalAlpha=.5,ctx.fillRect(w,this.shadow,this.shadow,h),ctx.fillRect(this.shadow,h,w-this.shadow,this.shadow)},PuzzlePreview.prototype.maximize=function(){this.resize()},PuzzlePreview.prototype.restore=function(){this.resize(160)},PuzzlePreview.prototype.toggleVisibility=function(){this.hidden=!this.hidden};